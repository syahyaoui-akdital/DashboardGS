<script>
/**
 * MODULE : RECOUVREMENT & EXPEDITION - OBJECTIFS VS RÉALISATIONS
 * Fonctionnalités : Drill-down, Projection, Comparaison Entités
 */

let objChartInstance = null;
let currentObjView = 'MONTH'; // 'MONTH' (vue annuelle par mois) ou 'DAY' (vue mensuelle par jour)
let drillMonth = null;        // Mois sélectionné pour le détail jour

// --- 1. IMPORTATION (Déjà gérée par le backend, ici pour rappel interface) ---
window.triggerObjRealImport = function() {
    if(!confirm("Lancer l'importation des objectifs ?")) return;
    const btn = document.querySelector('button[onclick="triggerObjRealImport()"]');
    const txt = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
    btn.disabled = true;
    google.script.run
        .withSuccessHandler(res => { alert(res); btn.innerHTML = txt; btn.disabled = false; loadRecouvData(); })
        .withFailureHandler(err => { alert("Erreur: "+err.message); btn.innerHTML = txt; btn.disabled = false; })
        .importObjRealData();
};

// --- 2. UPDATE DASHBOARD ---
window.updateObjRealDashboard = function() {
    // 1. Récupération Filtres
    const fEnt = document.getElementById('recouvFilterEntite').value;
    // On force l'année en string pour la comparaison
    const fAn = document.getElementById('recouvFilterAnnee').value; 
    const fMois = document.getElementById('recouvFilterMois').value;
    const fSub = document.getElementById('recouvFilterSubEntity') ? document.getElementById('recouvFilterSubEntity').value : "";
    
    // 2. Détermination de la famille cible (Recouvrement ou Expédition)
    // currentFamily est défini dans js_recouvrement_core.html
    let targetFamily = (typeof currentFamily !== 'undefined') ? currentFamily : "Recouvrement";
    
    // 3. Filtrage Données
    let filtered = objRealData.filter(d => {
        // A. Filtre Famille (Ex: ne garder que les lignes "Recouvrement" si on est dans l'onglet Recouvrement)
        // On normalise en majuscules pour éviter les erreurs de saisie (recouvrement vs RECOUVREMENT)
        if (!d.famille.toUpperCase().includes(targetFamily.toUpperCase())) return false;

        // B. Filtre Entité
        if (fEnt === "HIA CIOA") {
            // Si filtre global est HIA CIOA, on garde HIA et CIOA
            if (d.entite !== "HIA" && d.entite !== "CIOA") return false;
            // Si sous-filtre activé
            if (fSub && d.entite !== fSub) return false;
        } else if (fEnt && d.entite !== fEnt) {
            // Si une entité spécifique est sélectionnée (ex: CID)
            return false;
        }

        // C. Filtre Année (Comparaison String vs String)
        if (fAn && String(d.annee) !== String(fAn)) return false;

        return true;
    });

    // ... (Le reste de la fonction Gestion du Drill-down, Calcul KPI, etc. reste inchangé)
    
    // DEBUG : Si vous avez toujours 0, décommentez la ligne ci-dessous pour voir ce qui se passe dans la console (F12)
    // console.log("Données filtrées :", filtered, "TargetFamily:", targetFamily, "Filtre Entité:", fEnt);

    if (fMois) {
        currentObjView = 'DAY';
        drillMonth = fMois;
        document.getElementById('btnBackToMonth').style.display = 'none';
    } else if (currentObjView === 'DAY' && drillMonth) {
        document.getElementById('btnBackToMonth').style.display = 'flex';
    } else {
        currentObjView = 'MONTH';
        document.getElementById('btnBackToMonth').style.display = 'none';
    }

    if (currentObjView === 'DAY' && drillMonth) {
        filtered = filtered.filter(d => d.mois === drillMonth);
    }

    calculateObjKPIs(filtered, fMois);
    renderObjChart(filtered);
    renderObjTable(filtered);
};

// --- 3. CALCUL KPIs ---
function calculateObjKPIs(data, fMois) {
    const totObj = data.reduce((s,d) => s + (d.objectif||0), 0);
    const totReal = data.reduce((s,d) => s + (d.realisation||0), 0);
    const rate = totObj > 0 ? (totReal / totObj * 100) : 0;
    const gap = totReal - totObj;

    // Mise à jour DOM
    safeSetText('kpiObjVal', formatMoney(totObj));
    safeSetText('kpiRealVal', formatMoney(totReal));
    
    const elGap = document.getElementById('kpiRealGap');
    if (gap >= 0) { elGap.textContent = "+" + formatMoney(gap); elGap.style.color = "#10B981"; }
    else { elGap.textContent = formatMoney(gap); elGap.style.color = "#EF4444"; }

    safeSetText('kpiRateVal', rate.toFixed(1) + "%");
    const bar = document.getElementById('kpiRateBar');
    bar.style.width = Math.min(rate, 100) + "%";
    bar.style.backgroundColor = rate >= 100 ? "#10B981" : (rate >= 80 ? "#F59E0B" : "#EF4444");

    // PROJECTION (Règle de 3 sur le temps écoulé)
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = REC_MONTHS[today.getMonth()];
    
    let projection = 0;
    let projLabel = "Non disponible";

    // On projette seulement si on regarde le mois en cours ou l'année en cours
    const viewingCurrentPeriod = (currentObjView==='DAY' && drillMonth===currentMonth) || 
                                 (currentObjView==='MONTH' && document.getElementById('recouvFilterAnnee').value == currentYear);

    if (viewingCurrentPeriod && totReal > 0) {
        let daysPassed = today.getDate();
        let totalDays = new Date(currentYear, today.getMonth()+1, 0).getDate();
        
        if (currentObjView === 'MONTH') {
            // Projection Annuelle approximative
            let monthIndex = today.getMonth() + 1; // 1 à 12
            projection = (totReal / monthIndex) * 12;
            projLabel = "Projection Annuelle (Linéaire)";
        } else {
            // Projection Mensuelle
            projection = (totReal / daysPassed) * totalDays;
            projLabel = "Projection Fin de Mois";
        }
    } else {
        projection = totReal; // Si période passée, projection = réalisé
        projLabel = "Période Clôturée";
    }

    safeSetText('kpiProjVal', formatMoney(projection));
    safeSetText('kpiProjSub', projLabel);
}

// --- 4. GRAPHIQUE ---
function renderObjChart(data) {
    const ctx = document.getElementById('chartObjMain').getContext('2d');
    if (objChartInstance) objChartInstance.destroy();

    let labels = [], dObj = [], dReal = [];
    const titleEl = document.getElementById('chartObjTitle');

    if (currentObjView === 'MONTH') {
        titleEl.textContent = "Évolution Mensuelle";
        // Agrégation par Mois
        const agg = {};
        REC_MONTHS.forEach(m => agg[m] = {o:0, r:0});
        data.forEach(d => {
            if(agg[d.mois]) { agg[d.mois].o += d.objectif; agg[d.mois].r += d.realisation; }
        });
        labels = REC_MONTHS;
        dObj = labels.map(m => agg[m].o);
        dReal = labels.map(m => agg[m].r);
    } else {
        titleEl.textContent = `Détail Quotidien : ${drillMonth}`;
        // Agrégation par Jour (1 à 31)
        const daysInMonth = 31; // Simplification
        const agg = new Array(daysInMonth + 1).fill(0).map(() => ({o:0, r:0}));
        data.forEach(d => {
            if (d.jour >= 1 && d.jour <= 31) {
                agg[d.jour].o += d.objectif;
                agg[d.jour].r += d.realisation;
            }
        });
        labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
        dObj = labels.map(j => agg[j].o);
        dReal = labels.map(j => agg[j].r);
    }

    // Couleurs RH
    const colObj = '#94A3B8'; // Gris pour l'objectif
    const colReal = ctx.createLinearGradient(0,0,0,400); // Dégradé bleu/violet
    colReal.addColorStop(0, '#2E90FA'); colReal.addColorStop(1, '#6366F1');

    objChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Objectif', data: dObj,
                    type: 'line', borderColor: '#F59E0B', borderWidth: 2, pointRadius: 0,
                    borderDash: [5, 5], order: 0
                },
                {
                    label: 'Réalisé', data: dReal,
                    backgroundColor: colReal, borderRadius: 4, order: 1
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top', labels: { usePointStyle: true } },
                tooltip: {
                    callbacks: {
                        label: (ctx) => `${ctx.dataset.label}: ${formatMoney(ctx.raw)}`
                    }
                }
            },
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [2,2] }, ticks: { callback: v => v/1000 + 'k' } },
                x: { grid: { display: false } }
            },
            onClick: (e, els) => {
                if (currentObjView === 'MONTH' && els.length > 0) {
                    const idx = els[0].index;
                    drillMonth = REC_MONTHS[idx];
                    currentObjView = 'DAY';
                    updateObjRealDashboard(); // Redessine
                }
            }
        }
    });
}

// --- 5. TABLEAU ENTITÉS ---
function renderObjTable(data) {
    const tbody = document.querySelector('#tableObjPerf tbody');
    tbody.innerHTML = '';

    // Agrégation par Entité
    const agg = {};
    data.forEach(d => {
        if(!agg[d.entite]) agg[d.entite] = {o:0, r:0};
        agg[d.entite].o += d.objectif;
        agg[d.entite].r += d.realisation;
    });

    const sorted = Object.entries(agg).sort((a,b) => (b[1].r/b[1].o) - (a[1].r/a[1].o)); // Tri par taux

    sorted.forEach(([ent, val]) => {
        const rate = val.o > 0 ? (val.r / val.o * 100) : 0;
        let badgeClass = rate >= 100 ? 'good' : (rate >= 80 ? 'mid' : 'bad');
        
        const row = `
            <tr>
                <td style="font-weight:700; color:#334155;">${ent}</td>
                <td style="text-align:right; color:#64748B;">${formatMoney(val.o)}</td>
                <td style="text-align:right; color:#0F172A; font-weight:700;">${formatMoney(val.r)}</td>
                <td style="text-align:center;">
                    <span class="badge-perf ${badgeClass}">${rate.toFixed(0)}%</span>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}

// --- UTILS ---
function resetObjZoom() {
    currentObjView = 'MONTH';
    drillMonth = null;
    updateObjRealDashboard();
}

function normalizeTxt(s) {
    return String(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}
</script><script>
/**
 * MODULE : RECOUVREMENT & EXPEDITION - OBJECTIFS VS RÉALISATIONS
 * Fonctionnalités : Drill-down, Projection, Comparaison Entités
 */

let objChartInstance = null;
let currentObjView = 'MONTH'; // 'MONTH' (vue annuelle par mois) ou 'DAY' (vue mensuelle par jour)
let drillMonth = null;        // Mois sélectionné pour le détail jour

// --- 1. IMPORTATION (Déjà gérée par le backend, ici pour rappel interface) ---
window.triggerObjRealImport = function() {
    if(!confirm("Lancer l'importation des objectifs ?")) return;
    const btn = document.querySelector('button[onclick="triggerObjRealImport()"]');
    const txt = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
    btn.disabled = true;
    google.script.run
        .withSuccessHandler(res => { alert(res); btn.innerHTML = txt; btn.disabled = false; loadRecouvData(); })
        .withFailureHandler(err => { alert("Erreur: "+err.message); btn.innerHTML = txt; btn.disabled = false; })
        .importObjRealData();
};

// --- 2. UPDATE DASHBOARD ---
window.updateObjRealDashboard = function() {
    // 1. Récupération Filtres
    const fEnt = document.getElementById('recouvFilterEntite').value;
    // On force l'année en string pour la comparaison
    const fAn = document.getElementById('recouvFilterAnnee').value; 
    const fMois = document.getElementById('recouvFilterMois').value;
    const fSub = document.getElementById('recouvFilterSubEntity') ? document.getElementById('recouvFilterSubEntity').value : "";
    
    // 2. Détermination de la famille cible (Recouvrement ou Expédition)
    // currentFamily est défini dans js_recouvrement_core.html
    let targetFamily = (typeof currentFamily !== 'undefined') ? currentFamily : "Recouvrement";
    
    // 3. Filtrage Données
    let filtered = objRealData.filter(d => {
        // A. Filtre Famille (Ex: ne garder que les lignes "Recouvrement" si on est dans l'onglet Recouvrement)
        // On normalise en majuscules pour éviter les erreurs de saisie (recouvrement vs RECOUVREMENT)
        if (!d.famille.toUpperCase().includes(targetFamily.toUpperCase())) return false;

        // B. Filtre Entité
        if (fEnt === "HIA CIOA") {
            // Si filtre global est HIA CIOA, on garde HIA et CIOA
            if (d.entite !== "HIA" && d.entite !== "CIOA") return false;
            // Si sous-filtre activé
            if (fSub && d.entite !== fSub) return false;
        } else if (fEnt && d.entite !== fEnt) {
            // Si une entité spécifique est sélectionnée (ex: CID)
            return false;
        }

        // C. Filtre Année (Comparaison String vs String)
        if (fAn && String(d.annee) !== String(fAn)) return false;

        return true;
    });

    // ... (Le reste de la fonction Gestion du Drill-down, Calcul KPI, etc. reste inchangé)
    
    // DEBUG : Si vous avez toujours 0, décommentez la ligne ci-dessous pour voir ce qui se passe dans la console (F12)
    // console.log("Données filtrées :", filtered, "TargetFamily:", targetFamily, "Filtre Entité:", fEnt);

    if (fMois) {
        currentObjView = 'DAY';
        drillMonth = fMois;
        document.getElementById('btnBackToMonth').style.display = 'none';
    } else if (currentObjView === 'DAY' && drillMonth) {
        document.getElementById('btnBackToMonth').style.display = 'flex';
    } else {
        currentObjView = 'MONTH';
        document.getElementById('btnBackToMonth').style.display = 'none';
    }

    if (currentObjView === 'DAY' && drillMonth) {
        filtered = filtered.filter(d => d.mois === drillMonth);
    }

    calculateObjKPIs(filtered, fMois);
    renderObjChart(filtered);
    renderObjTable(filtered);
};

// --- 3. CALCUL KPIs ---
function calculateObjKPIs(data, fMois) {
    const totObj = data.reduce((s,d) => s + (d.objectif||0), 0);
    const totReal = data.reduce((s,d) => s + (d.realisation||0), 0);
    const rate = totObj > 0 ? (totReal / totObj * 100) : 0;
    const gap = totReal - totObj;

    // Mise à jour DOM
    safeSetText('kpiObjVal', formatMoney(totObj));
    safeSetText('kpiRealVal', formatMoney(totReal));
    
    const elGap = document.getElementById('kpiRealGap');
    if (gap >= 0) { elGap.textContent = "+" + formatMoney(gap); elGap.style.color = "#10B981"; }
    else { elGap.textContent = formatMoney(gap); elGap.style.color = "#EF4444"; }

    safeSetText('kpiRateVal', rate.toFixed(1) + "%");
    const bar = document.getElementById('kpiRateBar');
    bar.style.width = Math.min(rate, 100) + "%";
    bar.style.backgroundColor = rate >= 100 ? "#10B981" : (rate >= 80 ? "#F59E0B" : "#EF4444");

    // PROJECTION (Règle de 3 sur le temps écoulé)
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = REC_MONTHS[today.getMonth()];
    
    let projection = 0;
    let projLabel = "Non disponible";

    // On projette seulement si on regarde le mois en cours ou l'année en cours
    const viewingCurrentPeriod = (currentObjView==='DAY' && drillMonth===currentMonth) || 
                                 (currentObjView==='MONTH' && document.getElementById('recouvFilterAnnee').value == currentYear);

    if (viewingCurrentPeriod && totReal > 0) {
        let daysPassed = today.getDate();
        let totalDays = new Date(currentYear, today.getMonth()+1, 0).getDate();
        
        if (currentObjView === 'MONTH') {
            // Projection Annuelle approximative
            let monthIndex = today.getMonth() + 1; // 1 à 12
            projection = (totReal / monthIndex) * 12;
            projLabel = "Projection Annuelle (Linéaire)";
        } else {
            // Projection Mensuelle
            projection = (totReal / daysPassed) * totalDays;
            projLabel = "Projection Fin de Mois";
        }
    } else {
        projection = totReal; // Si période passée, projection = réalisé
        projLabel = "Période Clôturée";
    }

    safeSetText('kpiProjVal', formatMoney(projection));
    safeSetText('kpiProjSub', projLabel);
}

// --- 4. GRAPHIQUE ---
function renderObjChart(data) {
    const ctx = document.getElementById('chartObjMain').getContext('2d');
    if (objChartInstance) objChartInstance.destroy();

    let labels = [], dObj = [], dReal = [];
    const titleEl = document.getElementById('chartObjTitle');

    if (currentObjView === 'MONTH') {
        titleEl.textContent = "Évolution Mensuelle";
        // Agrégation par Mois
        const agg = {};
        REC_MONTHS.forEach(m => agg[m] = {o:0, r:0});
        data.forEach(d => {
            if(agg[d.mois]) { agg[d.mois].o += d.objectif; agg[d.mois].r += d.realisation; }
        });
        labels = REC_MONTHS;
        dObj = labels.map(m => agg[m].o);
        dReal = labels.map(m => agg[m].r);
    } else {
        titleEl.textContent = `Détail Quotidien : ${drillMonth}`;
        // Agrégation par Jour (1 à 31)
        const daysInMonth = 31; // Simplification
        const agg = new Array(daysInMonth + 1).fill(0).map(() => ({o:0, r:0}));
        data.forEach(d => {
            if (d.jour >= 1 && d.jour <= 31) {
                agg[d.jour].o += d.objectif;
                agg[d.jour].r += d.realisation;
            }
        });
        labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
        dObj = labels.map(j => agg[j].o);
        dReal = labels.map(j => agg[j].r);
    }

    // Couleurs RH
    const colObj = '#94A3B8'; // Gris pour l'objectif
    const colReal = ctx.createLinearGradient(0,0,0,400); // Dégradé bleu/violet
    colReal.addColorStop(0, '#2E90FA'); colReal.addColorStop(1, '#6366F1');

    objChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Objectif', data: dObj,
                    type: 'line', borderColor: '#F59E0B', borderWidth: 2, pointRadius: 0,
                    borderDash: [5, 5], order: 0
                },
                {
                    label: 'Réalisé', data: dReal,
                    backgroundColor: colReal, borderRadius: 4, order: 1
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top', labels: { usePointStyle: true } },
                tooltip: {
                    callbacks: {
                        label: (ctx) => `${ctx.dataset.label}: ${formatMoney(ctx.raw)}`
                    }
                }
            },
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [2,2] }, ticks: { callback: v => v/1000 + 'k' } },
                x: { grid: { display: false } }
            },
            onClick: (e, els) => {
                if (currentObjView === 'MONTH' && els.length > 0) {
                    const idx = els[0].index;
                    drillMonth = REC_MONTHS[idx];
                    currentObjView = 'DAY';
                    updateObjRealDashboard(); // Redessine
                }
            }
        }
    });
}

// --- 5. TABLEAU ENTITÉS ---
function renderObjTable(data) {
    const tbody = document.querySelector('#tableObjPerf tbody');
    tbody.innerHTML = '';

    // Agrégation par Entité
    const agg = {};
    data.forEach(d => {
        if(!agg[d.entite]) agg[d.entite] = {o:0, r:0};
        agg[d.entite].o += d.objectif;
        agg[d.entite].r += d.realisation;
    });

    const sorted = Object.entries(agg).sort((a,b) => (b[1].r/b[1].o) - (a[1].r/a[1].o)); // Tri par taux

    sorted.forEach(([ent, val]) => {
        const rate = val.o > 0 ? (val.r / val.o * 100) : 0;
        let badgeClass = rate >= 100 ? 'good' : (rate >= 80 ? 'mid' : 'bad');
        
        const row = `
            <tr>
                <td style="font-weight:700; color:#334155;">${ent}</td>
                <td style="text-align:right; color:#64748B;">${formatMoney(val.o)}</td>
                <td style="text-align:right; color:#0F172A; font-weight:700;">${formatMoney(val.r)}</td>
                <td style="text-align:center;">
                    <span class="badge-perf ${badgeClass}">${rate.toFixed(0)}%</span>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}

// --- UTILS ---
function resetObjZoom() {
    currentObjView = 'MONTH';
    drillMonth = null;
    updateObjRealDashboard();
}

function normalizeTxt(s) {
    return String(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}
</script>