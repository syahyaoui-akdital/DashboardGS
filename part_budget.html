<div id="view-ca-budget" class="view-section export-section" data-export-title="CA vs Budget">
    <div style="display: flex; height: calc(100vh - 140px); min-height: 600px; border: 1px solid #e1e8f0; border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.03);">
        
        <div style="width: 260px; background: #f8faff; border-right: 1px solid #e1e8f0; display: flex; flex-direction: column; flex-shrink: 0; z-index: 2;">
            <div style="padding: 30px 20px; border-bottom: 1px solid #e1e8f0; background: white;">
                <div style="font-size: 0.7em; text-transform: uppercase; color: #363795; font-weight: 800; letter-spacing: 1px; margin-bottom: 15px;">Management</div>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 0.7em; color: #888; font-weight: 600; margin-bottom: 2px;">RESPONSABLE EXPLOITATION</div>
                    <div id="budgetResp" style="font-size: 0.95em; color: #333; font-weight: 700;">-</div>
                </div>
                <div>
                    <div style="font-size: 0.7em; color: #888; font-weight: 600; margin-bottom: 2px;">DIRECTEUR MÉDICAL</div>
                    <div id="budgetDirMed" style="font-size: 0.95em; color: #333; font-weight: 700;">-</div>
                </div>
            </div>
            <div style="padding: 20px; flex-grow: 1; display: flex; flex-direction: column; gap: 12px;">
                <div style="font-size: 0.7em; text-transform: uppercase; color: #999; font-weight: 800; letter-spacing: 1px; margin-bottom: 5px;">Analyses</div>
                <button class="budget-nav-btn active" onclick="setBudgetMode('trend')" id="btnModeTrend">Analyse Chiffre d'affaires</button>
                <button class="budget-nav-btn" onclick="setBudgetMode('comparison')" id="btnModeComparison">CA vs Budget</button>
            </div>
            <div id="budgetSidebarLists" class="export-section" data-export-title="Top / Flop Performances" style="padding: 20px; background: #fff; border-top: 1px solid #e1e8f0;">
                 <div style="font-size: 0.7em; text-transform: uppercase; color: #27ae60; font-weight: 800; letter-spacing: 1px; margin-bottom: 10px;">Top Performance</div>
                 <div id="topPerfList" style="display:flex; flex-direction:column; gap:8px;"></div>
                 <div style="font-size: 0.7em; text-transform: uppercase; color: #e74c3c; font-weight: 800; letter-spacing: 1px; margin-bottom: 10px; margin-top: 20px;">À Suivre</div>
                 <div id="flopPerfList" style="display:flex; flex-direction:column; gap:8px;"></div>
            </div>
        </div>

        <div style="flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; background: white;">
            <div style="padding: 20px 30px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap:wrap; gap:15px;">
                <div>
                    <h2 id="ctxBudgetTitle" style="margin: 0; font-size: 1.5em; color: #333; font-weight: 700;">Vue Globale</h2>
                    <span id="ctxBudgetSubtitle" style="color: #888; font-size: 0.9em; font-weight: 500;">-</span>
                </div>
                <div id="secondaryFiltersPanel" style="background: transparent; box-shadow: none; padding: 0; margin: 0; gap: 15px; display:flex; align-items: flex-end;">
                    <div class="sec-filter-group">
                        <label>Entité</label>
                        <select id="localBudgetEntite" onchange="syncBudgetFilters('entite')"></select>
                    </div>

                    <div class="sec-filter-group" id="subFilterHiaCioa" style="display:none; animation: fadeIn 0.3s;">
                        <label style="color:#363795;">Sous Entité</label>
                        <select id="localSubFilter" onchange="updateCaBudgetView()" style="border-color:#363795; background:#f8f9ff; font-weight:600; padding:8px; border-radius:5px;"><option value="">Global (HIA + CIOA)</option><option value="HIA">Multi (HIA)</option><option value="CIOA">Onco (CIOA)</option></select>
                    </div>
                    
                    <div class="sec-filter-group">
                        <label>Année</label>
                        <select id="localBudgetAnnee" onchange="syncBudgetFilters('annee')"></select>
                    </div>

                    <div class="sec-filter-group"><label>Trim</label><select id="localBudgetTrimestre" onchange="syncBudgetFilters('trimestre')"></select></div>
                    
                    <div class="sec-filter-group"><label>Mois</label><select id="localBudgetMois" onchange="syncBudgetFilters('mois')"></select></div>
                </div>
            </div>

            <div style="padding: 30px; display: flex; flex-direction: column; gap: 30px;">
                <div id="budgetKPIs" class="export-section cards-row" data-export-title="Indicateurs Budget" style="margin-bottom: 0; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); display: grid; gap: 20px;">
                    <div class="stat-card" style="border: 1px solid #eee; border-top: 4px solid #363795;">
                        <div class="stat-title">CA RÉALISÉ</div>
                        <div id="cardCaRealise" class="stat-value" style="font-size: 1.6em;">--</div>
                        <div id="cardCaEvol" class="evolution-tag" style="display:inline-block; margin-top:5px;">--</div>
                    </div>
                    <div class="stat-card budget" style="border: 1px solid #eee; border-top: 4px solid #f1c40f;">
                        <div class="stat-title">OBJECTIF (BUDGET)</div>
                        <div id="cardBudget" class="stat-value" style="font-size: 1.6em;">--</div>
                        <div id="cardBudgetMensuel" class="stat-sub">--</div>
                    </div>
                    <div class="stat-card" id="cardResteContainer" style="border: 1px solid #eee; border-top: 4px solid #e74c3c; background: #fff5f5;">
                        <div class="stat-title" id="cardResteTitle" style="color:#c0392b;">RESTE À FAIRE (Annuel)</div>
                        <div id="cardResteFaire" class="stat-value" style="font-size: 1.6em; color:#c0392b;">--</div>
                        <div id="cardResteMois" class="stat-sub" style="color:#e74c3c; font-weight:600;">--</div>
                    </div>
                    <div class="stat-card taux" style="border: 1px solid #eee; border-top: 4px solid #27ae60;">
                        <div class="stat-title">RÉALISATION</div>
                        <div id="cardTaux" class="stat-value" style="font-size: 1.6em;">-- %</div>
                        <div id="cardEcart" class="stat-sub">--</div>
                    </div>
                </div>

                <div id="budgetChart" class="export-section chart-container" data-export-title="Graphique Budget" style="background: white; border: 1px solid #eee; padding: 20px; border-radius: 12px; height: 450px; box-shadow: 0 4px 10px rgba(0,0,0,0.02);">
                    <canvas id="caBudgetChart"></canvas>
                </div>

                <div id="budgetTable" class="export-section table-container" data-export-title="Tableau de Données Budget" style="border: 1px solid #eee; box-shadow: none; border-radius: 12px;">
                    <table id="tableCaBudget">
                        <thead>
                            <tr>
                                <th style="background:#f8faff; padding-left: 20px;">Entité</th>
                                <th style="background:#f8faff;">CA 2025</th>
                                <th style="background:#f8faff;">CA 2026</th>
                                <th style="background:#f8faff;">Variation</th>
                                <th style="background:#f8faff;">Budget 2026</th>
                                <th style="background:#f8faff; padding-right: 20px;">% Réal.</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes fadeIn { from { opacity:0; transform:translateY(-5px); } to { opacity:1; transform:translateY(0); } }
    .budget-nav-btn { padding: 12px 15px; background: white; border: 1px solid #eee; border-radius: 8px; color: #666; font-weight: 600; font-size: 0.85em; cursor: pointer; text-align: left; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom: 5px; }
    .budget-nav-btn:hover { background: linear-gradient(90deg, #fff 0%, #f4f6f9 100%); border-color: #d0d7de; color: #363795; transform: translateX(3px); }
    .budget-nav-btn.active { background: linear-gradient(135deg, #363795 0%, #005c97 100%); color: white; border: none; box-shadow: 0 4px 10px rgba(54, 55, 149, 0.3); }
    #tableCaBudget th { color: #666; font-weight: 700; border-bottom: 2px solid #eee; }
    #tableCaBudget td { padding: 12px 15px; border-bottom: 1px solid #f5f5f5; color: #444; }
    #tableCaBudget tr:hover td { background-color: #fcfcfc; }
    #tableCaBudget tr:last-child td { border-bottom: none; }
    body.dark-mode .budget-nav-btn { background: #333; color: #eee; border-color: #444; }
    body.dark-mode .budget-nav-btn:hover { background: #444; }
    body.dark-mode .budget-nav-btn.active { background: linear-gradient(135deg, #363795 0%, #005c97 100%); color:white; }
    body.dark-mode #view-ca-budget > div { background: #2d2d2d; border-color: #444; }
    body.dark-mode div[style*="width: 260px"] { background: #1f1f1f; border-right-color: #444; }
    body.dark-mode div[style*="border-bottom: 1px solid #e1e8f0"] { border-bottom-color: #444; background: #2d2d2d; }
    body.dark-mode div[style*="background: #fff;"] { background: #2d2d2d !important; }
    body.dark-mode .chart-container { background: #2d2d2d !important; border-color: #444 !important; }
    body.dark-mode .table-container { border-color: #444 !important; }
    body.dark-mode #tableCaBudget th { background: #333 !important; color: #ccc; border-bottom-color: #444; }
    body.dark-mode #tableCaBudget td { color: #eee; border-bottom-color: #444; }
    body.dark-mode div[style*="overflow-y: auto; background: white;"] { background: #1a1a1a !important; }
    body.dark-mode .stat-card { background: #2d2d2d; border-color: #444 !important; }
    body.dark-mode .stat-card[style*="background: #fff5f5"] { background: #3a1c1c !important; } 
    body.dark-mode .sec-filter-group select { background: #333; color: #eee; border-color: #555; }
    body.dark-mode #ctxBudgetTitle { color: #eee !important; }
    body.dark-mode #budgetResp, body.dark-mode #budgetDirMed { color: #eee !important; }
</style>