<script>

  // =======================================================================
  //  1. CONFIGURATION & VARIABLES GLOBALES
  // =======================================================================
  Chart.register(ChartDataLabels);
  Chart.defaults.color = '#333';
  
  // Variables de donn√©es
  window.rawData = {}; 
  window.normalizedData = []; 
  window.extraContactData = {}; 
  window.extraCAData = {}; 
  window.extraCapacityData = {}; 
  
  // --- NOUVEAU : CONTEXTE S√âCURIT√â ---
  let currentUserContext = null; 
  // -----------------------------------

  // Instances Graphiques
  window.kpiChartInstance = null; 
  window.laboChartInstance = null; 
  window.historyChartInstance = null;
  window.caChartInstance = null;
  window.isHonorairesLoaded = false;
  
  window.monthOrder = ["JAN", "FEV", "MAR", "AVR", "MAI", "JUIN", "JUIL", "AOU", "SEP", "OCT", "NOV", "DEC"];
  window.quarters = { "T1": ["JAN", "FEV", "MAR"], "T2": ["AVR", "MAI", "JUIN"], "T3": ["JUIL", "AOU", "SEP"], "T4": ["OCT", "NOV", "DEC"] };
  window.monthToQuarterMap = { "JAN":"T1", "FEV":"T1", "MAR":"T1", "AVR":"T2", "MAI":"T2", "JUIN":"T2", "JUIL":"T3", "AOU":"T3", "SEP":"T3", "OCT":"T4", "NOV":"T4", "DEC":"T4" };
  window.ENTITY_ORDER = ["HIA CIOA", "CIT", "CID", "PIL", "HPG", "ALHIKMA"];
  const FAMILIES_ORDER = ["Hospitalisation", "Bloc", "Salle de cath√© et rythmologie", "Radioth√©rapie", "Chimioth√©rapie", "M√©decine nucl√©aire", "Dialyse", "H√¥pital du jour", "Radiologie", "Laboratoire", "Consultation", "Urgence", "Centre de r√©√©ducation", "Curieth√©rapie et CHIP"];
  const DEFAULT_FAMILY = "Hospitalisation";
  const TOTAL_REGION_LABEL = "R√©gion Grand-Sud";

  // --- UTILITAIRES GLOBAUX ---
  window.isFilterValueValid = function(v) { return v !== null && v !== undefined && String(v).trim() !== '' && String(v).trim() !== '-'; };
  window.formatValue = function(v) { if (v === 'N/A' || v === '--' || v == null || isNaN(v)) return '--'; return Math.round(parseFloat(v)).toLocaleString('fr-FR'); };
  window.formatMoney = function(v) { return (v === undefined || v === null) ? "0" : Math.round(v).toLocaleString('fr-FR') + " "; };
  window.formatDecimal = function(value) { if (value === 'N/A' || value === '--' || value == null || isNaN(value) || !isFinite(value)) return '--'; return parseFloat(value).toLocaleString('fr-FR', { minimumFractionDigits: 1, maximumFractionDigits: 1 }); };

// --- A REMPLACER : GESTION DE LA S√âCURIT√â ---
// --- S√âCURIT√â & VERROUILLAGE ---
// =======================================================================
  //  FONCTION DE S√âCURIT√â RENFORC√âE (Ultra-Strict)
  // =======================================================================
  window.applyUserPermissions = function(role, entity) {
      // 1. Contexte
      role = role || (window.currentUserContext ? window.currentUserContext.role : null);
      entity = entity || (window.currentUserContext ? window.currentUserContext.entity : null);
      window.currentUserContext = { role: role, entity: entity };

      console.log("üîí S√©curit√© | R√¥le:", role, "| Entit√©:", entity);

      // =========================================================
      // PARTIE 1 : MASQUAGE DES IMPORTS (Pour NON-ADMIN)
      // =========================================================
      const isAdmin = (role === 'ADMIN');
      
      if (!isAdmin) {
          // A. Liste des IDs suspects d'√™tre des boutons d'import
          const importIds = [
              'btnUpdate',                // Header
              'recouvImportZone',         // Recouvrement (Zone Orange)
              'importZone',               // Nom g√©n√©rique
              'btnImport',                // Nom g√©n√©rique
              'fileInput',                // Input fichier g√©n√©rique
              'btnUpload'                 // Bouton upload
          ];

          importIds.forEach(id => {
              const el = document.getElementById(id);
              if (el) el.style.display = 'none';
          });

          // B. Masquer TOUS les champs de type "Fichier" (S√©curit√© absolue)
          document.querySelectorAll('input[type="file"]').forEach(el => {
              // On masque l'input et son parent direct (souvent le bouton stylis√©)
              el.style.display = 'none';
              if(el.parentElement && el.parentElement.tagName === 'LABEL') {
                  el.parentElement.style.display = 'none';
              }
          });

          // C. Masquer les boutons contenant le mot "Import" dans leur action (onclick)
          document.querySelectorAll('button').forEach(btn => {
              const onClickText = btn.getAttribute('onclick') || "";
              const textContent = btn.textContent || "";
              
              // Si le bouton lance une fonction "Import" ou contient le texte "Import"
              if (onClickText.toLowerCase().includes('import') || 
                  onClickText.toLowerCase().includes('upload') ||
                  textContent.includes('Import') || 
                  textContent.includes('Charger le fichier')) {
                  
                  btn.style.display = 'none';
              }
          });

          // D. Masquer par classe CSS sp√©cifique (si vous l'avez ajout√©e)
          document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
      } 
      // Si ADMIN, on s'assure que tout est visible (optionnel, d√©pend de votre CSS de base)
      else {
           document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
      }

      // =========================================================
      // PARTIE 2 : VERROUILLAGE FILTRES (Pour VIEWER_ENTITY)
      // =========================================================
      if (role === 'VIEWER_ENTITY' && entity) {
          const filterIds = [
              'entite',                 // Header Global
              'localEntite',            // Flash Sidebar
              'localBudgetEntite',      // Budget (ID corrig√©)
              'recouvFilterEntite',     // Recouvrement
              'depenseFilterEntite',    // D√©penses (ID corrig√©)
              'honoFilterEntite',       // Honoraires (ID corrig√©)
              'rhEntite',               // RH (ID corrig√©)
              'expedFilterEntite'       // Exp√©dition
          ];

          filterIds.forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                  el.value = entity; 
                  // Force l'ajout de l'option si manquante
                  if (el.value !== entity) {
                      const opt = document.createElement('option');
                      opt.value = entity; opt.text = entity; el.add(opt); el.value = entity;
                  }
                  // Style Verrouill√©
                  el.disabled = true;
                  el.style.backgroundColor = "#e5e7eb";
                  el.style.color = "#6b7280";
                  el.style.opacity = "0.7";
                  el.style.fontWeight = "bold";
                  el.style.cursor = "not-allowed";
              }
          });
      }
      // =========================================================
      // PARTIE 3 : RESPONSABLE RECOUVREMENT (NOUVEAU)
      // Masquer tous les onglets sauf Recouvrement
      // =========================================================
if (role === 'VIEWER_RECOUV') {
          // Cache les onglets interdits
          ['flash', 'budget', 'depenses', 'rh', 'honoraires'].forEach(tab => {
              const selector = `button[onclick*="${tab}"]`;
              document.querySelectorAll(selector).forEach(b => b.style.display = 'none');
          });
          // Cache la sidebar Flash si elle est rest√©e ouverte
          const sb = document.getElementById('sidebar');
          if(sb) sb.style.display = 'none';
      }
  };

  // =======================================================================
  //  2. GESTION CONNEXION & S√âCURIT√â (NOUVEAU)
  // =======================================================================

  document.addEventListener('DOMContentLoaded', () => {
      // On pr√©pare juste l'interface, pas de chargement de donn√©es ici.
      // Le chargement se fait via attemptLogin().
      console.log("Application pr√™te √† la connexion.");
  });

function attemptLogin() {
    const u = document.getElementById('loginUser').value.trim().toLowerCase();
    const p = document.getElementById('loginPass').value.trim();
    const detectedEmailEl = document.getElementById('detectedEmail');
    const detectedEmail = detectedEmailEl ? detectedEmailEl.value.trim().toLowerCase() : '';
    
    const btn = document.getElementById('btnLogin');
    const err = document.getElementById('loginError');

    if(!u || !p) {
        err.innerHTML = "<i class='fas fa-exclamation-circle'></i> Veuillez remplir l'utilisateur et le mot de passe.";
        err.style.display = 'block';
        return;
    }

    // Validation Client : Username == Email Prefix
    if (detectedEmail) {
        const prefix = detectedEmail.split('@')[0];
        if (u !== prefix) {
            err.innerHTML = `<i class='fas fa-shield-alt'></i> <b>Erreur de s√©curit√© :</b><br>L'utilisateur saisi (<b>${u}</b>) ne correspond pas au compte Google connect√© (<b>${prefix}</b>).`;
            err.style.display = 'block';
            return;
        }
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> V√©rification...';
    err.style.display = 'none';

    google.script.run
        .withSuccessHandler(function(res) {
            if (res.success) {
                // 1. Stockage du contexte utilisateur avec les nouvelles infos
                window.currentUserContext = {
                    role: res.role,
                    entity: res.entity,
                    username: res.username,
                    email: res.email,
                    poste: res.poste,
                    photo: res.photo
                };

                // 2. MISE √Ä JOUR VISUELLE DU PROFIL DANS LE HEADER
                const nameEl = document.getElementById('connectedUserName');
                const posteEl = document.getElementById('connectedUserPoste');
                const photoEl = document.getElementById('connectedUserPhoto');
                
                if (nameEl) nameEl.textContent = res.username.toUpperCase();
                if (posteEl) posteEl.textContent = res.poste || 'Utilisateur';
                
                if (photoEl) {
                    // Si pas de photo dans la base, on g√©n√®re un avatar avec la premi√®re lettre
                    const photoUrl = res.photo ? res.photo : `https://ui-avatars.com/api/?name=${res.username}&background=f8faff&color=363795&bold=true`;
                    photoEl.src = photoUrl;
                }

                // 3. Application des permissions
                if(typeof applyUserPermissions === 'function') {
                    applyUserPermissions(res.role, res.entity);
                }

                // 4. Transition UI
                const overlay = document.getElementById('loginOverlay');
                overlay.style.transition = 'opacity 0.5s';
                overlay.style.opacity = '0';
                
                setTimeout(() => { 
                    overlay.style.display = 'none'; 
                    document.body.style.overflow = 'auto';
                    
                    // Lancement du Dashboard
                    const app = document.getElementById('appContainer');
                    if(app) {
                        app.style.display = 'flex';
                        if(typeof loadData === 'function') loadData(); 
                        window.dispatchEvent(new Event('resize'));
                    }
                }, 500);

            } else {
                err.innerHTML = `<i class='fas fa-exclamation-triangle'></i> ${res.message}`;
                err.style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = 'SE CONNECTER <i class="fas fa-arrow-right"></i>';
            }
        })
        .withFailureHandler(function(e) {
            err.innerHTML = `<i class='fas fa-wifi'></i> Erreur de connexion serveur : ${e.message}`;
            err.style.display = 'block';
            btn.disabled = false;
            btn.innerHTML = 'SE CONNECTER <i class="fas fa-arrow-right"></i>';
        })
        .verifyCustomLogin(u, p, window.clientIP || "Unknown"); 
}

  function initializeDashboardWithSecurity(data) {
      // 1. Initialisation standard
      initializeDashboard(data);
      
      // 2. Enregistrement du contexte utilisateur
      if(data.userContext) {
          currentUserContext = data.userContext;
          applySecurityRules(); // Applique les restrictions imm√©diatement
      }

      // 3. Transition UI : Cacher Login -> Afficher App
      const loginPage = document.getElementById('loginPage');
      const appContainer = document.getElementById('appContainer');
      
      if(loginPage) {
          loginPage.style.opacity = '0';
          setTimeout(() => loginPage.style.display = 'none', 300);
      }
      
      if(appContainer) {
          appContainer.style.display = 'flex';
          // Redimensionnement n√©cessaire des charts
          setTimeout(() => {
              if(window.kpiChartInstance) window.kpiChartInstance.resize();
              window.dispatchEvent(new Event('resize'));
          }, 300);
      }
  }

  function applySecurityRules() {
      if (!currentUserContext) return;

      const role = currentUserContext.role;
      const entity = currentUserContext.entity;

      // A. R√àGLE ADMIN (Import)
      if (role !== 'ADMIN') {
          const btnUpdate = document.getElementById('btnUpdate');
          if(btnUpdate) btnUpdate.style.display = 'none';
          
          const idsToHide = ['recouvImportZone', 'depenseImportZone', 'honoImportZone'];
          idsToHide.forEach(id => {
              const el = document.getElementById(id);
              if(el) el.style.display = 'none';
          });

          // Fallback pour les inputs fichiers sans ID wrapper propre
          ['fileExpenses', 'fileHonoraires', 'fileRecouv'].forEach(inputId => {
              const input = document.getElementById(inputId);
              if(input && input.parentNode) input.parentNode.style.display = 'none';
          });
          
          const btnObj = document.querySelector('button[onclick="triggerObjRealImport()"]');
          if(btnObj) btnObj.style.display = 'none';
      }

      // B. R√àGLE ENTIT√â (Verrouillage Filtre)
      if (entity !== 'ALL') {
          const selectEntite = document.getElementById('entite');
          if (selectEntite) {
              selectEntite.value = entity;
              selectEntite.disabled = true;
              selectEntite.style.backgroundColor = "#e9ecef";
              selectEntite.style.color = "#555";
              selectEntite.style.cursor = "not-allowed";
              selectEntite.style.border = "1px solid #ccc";
              
              // Force la synchro des filtres locaux
              syncFilters('entite');
          }
          
          // Badge visuel dans le header
          const headerTitle = document.querySelector('header h2');
          if(headerTitle && !document.getElementById('entityBadge')) {
              headerTitle.innerHTML += ` <span id="entityBadge" style="font-size:0.6em; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:10px; vertical-align:middle;">${entity}</span>`;
          }
      }
  }

  // =======================================================================
  //  3. CONFIGURATION D'EXPORTATION INTELLIGENTE
  // =======================================================================
  
  function hasDataFor(familleKeyword, elementKeyword = null) {
      const entite = document.getElementById('entite') ? document.getElementById('entite').value : '';
      return window.normalizedData.some(row => {
          if (entite && row[0] !== entite) return false;
          const rowFam = String(row[2] || "").toUpperCase();
          const rowSub = String(row[3] || "").toUpperCase();
          const rowEl = String(row[4] || "").toUpperCase();

          if (!rowFam.includes(familleKeyword.toUpperCase())) return false;
          if (elementKeyword) {
              const kw = elementKeyword.toUpperCase();
              return rowSub.includes(kw) || rowEl.includes(kw);
          }
          return true;
      });
  }

  function setFlashFilters(fam, subFam, element) {
      if(typeof selectFamily === 'function') selectFamily(fam);
      
      setTimeout(() => {
          const sfSelect = document.getElementById('sousFamille');
          
          if(subFam && sfSelect) {
              let foundSF = false;
              for(let opt of sfSelect.options) {
                  if(opt.value.toUpperCase().includes(subFam.toUpperCase())) {
                      sfSelect.value = opt.value;
                      sfSelect.dispatchEvent(new Event('change'));
                      foundSF = true; break;
                  }
              }
              if(!foundSF) { sfSelect.value = ""; sfSelect.dispatchEvent(new Event('change')); }
          } else if (sfSelect) {
              sfSelect.value = ""; sfSelect.dispatchEvent(new Event('change'));
          }

          if(element) {
              setTimeout(() => {
                  const elSelect = document.getElementById('element');
                  if(elSelect) {
                      for(let opt of elSelect.options) {
                          if(opt.value.toUpperCase().includes(element.toUpperCase())) {
                              elSelect.value = opt.value;
                              elSelect.dispatchEvent(new Event('change'));
                              break;
                          }
                      }
                  }
              }, 300);
          }
      }, 150);
  }

  function forceSwitchFamily(main, sub) { if(typeof switchFamily === 'function') switchFamily(main, sub); }

  const EXPORT_CONFIG = {
      "FLASH_1": {
          title: "1. HOSPITALISATION",
          targetId: "view-flash",
          items: [
              { name: "1.1 Vue Globale Hospitalisation", condition: () => hasDataFor('Hospitalisation'), action: () => setFlashFilters('Hospitalisation', '', '') },
              { name: "1.2 R√©animation (Globale)", condition: () => hasDataFor('Hospitalisation', 'R√âANIMATION'), action: () => setFlashFilters('Hospitalisation', 'R√âANIMATION', '') },
              { name: "1.2.1 R√©animation Polyvalente", condition: () => hasDataFor('Hospitalisation', 'POLY'), action: () => setFlashFilters('Hospitalisation', 'R√âANIMATION', 'Poly') },
              { name: "1.2.2 R√©animation CCV", condition: () => hasDataFor('Hospitalisation', 'CCV'), action: () => setFlashFilters('Hospitalisation', 'R√âANIMATION', 'CCV') },
              { name: "1.2.3 R√©animation N√©o-natale", condition: () => hasDataFor('Hospitalisation', 'NEO') || hasDataFor('Hospitalisation', 'N√âO'), action: () => setFlashFilters('Hospitalisation', 'R√âANIMATION', 'N√©o') },            
              { name: "1.3 Soins Intensifs (Global)", condition: () => hasDataFor('Hospitalisation', 'SOINS INTENSIFS'), action: () => setFlashFilters('Hospitalisation', 'SOINS INTENSIFS', '') },
              { name: "1.3.1 USI Polyvalente", condition: () => hasDataFor('Hospitalisation', 'USI') && (hasDataFor('Hospitalisation', 'POLY') || hasDataFor('Hospitalisation', 'USIP')), action: () => setFlashFilters('Hospitalisation', 'SOINS INTENSIFS', 'Poly') },
              { name: "1.3.2 USI Oncologie", condition: () => hasDataFor('Hospitalisation', 'USI') && (hasDataFor('Hospitalisation', 'ONCO') || hasDataFor('Hospitalisation', 'USIO')), action: () => setFlashFilters('Hospitalisation', 'SOINS INTENSIFS', 'Onco') },
              { name: "1.3.3 USI CCV (Cardio)", condition: () => hasDataFor('Hospitalisation', 'USI') && (hasDataFor('Hospitalisation', 'CCV') || hasDataFor('Hospitalisation', 'USIC')), action: () => setFlashFilters('Hospitalisation', 'SOINS INTENSIFS', 'CCV') },
              { name: "1.4 Maternit√©", condition: () => hasDataFor('Hospitalisation', 'MATERNIT'), action: () => setFlashFilters('Hospitalisation', 'MATERNITE', '') },
              { name: "1.5 HMC", condition: () => hasDataFor('Hospitalisation', 'HMC'), action: () => setFlashFilters('Hospitalisation', 'HMC', '') }
          ]
      },
      "FLASH_2": {
          title: "2. BLOC & CATH√âT√âRISME",
          targetId: "view-flash",
          items: [
              { name: "2.1 Bloc Op√©ratoire", condition: () => hasDataFor('Bloc'), action: () => setFlashFilters('Bloc', '', '') },
              { name: "2.2 Cath√©t√©risme", condition: () => hasDataFor('cath√©'), action: () => setFlashFilters('Salle de cath√© et rythmologie', '', '') }
          ]
      },
      "FLASH_3": {
          title: "3. RADIOTH√âRAPIE & CHIMIOTH√âRAPIE",
          targetId: "view-flash",
          items: [
              { name: "3.1 Radioth√©rapie (Passage)", condition: () => hasDataFor('Radioth√©rapie', 'Passage'), action: () => setFlashFilters('Radioth√©rapie', 'Passage sur la machine') },
              { name: "3.2 Radioth√©rapie (Technique)", condition: () => hasDataFor('Radioth√©rapie', 'Technique'), action: () => setFlashFilters('Radioth√©rapie', 'technique') },
              { name: "3.3 Chimioth√©rapie (S√©ances)", condition: () => hasDataFor('Chimioth√©rapie', 'Passage'), action: () => setFlashFilters('Chimioth√©rapie', "Passage au niveau de l'HDJ") },
              { name: "3.4 Chimioth√©rapie (Nouveaux Cas)", condition: () => hasDataFor('Chimioth√©rapie', 'Nouveaux cas'), action: () => setFlashFilters('Chimioth√©rapie', 'Nouveaux cas') }
          ]
      },
      "FLASH_4": {
          title: "4. RADIOLOGIE & LABORATOIRE",
          targetId: "view-flash",
          items: [
              { name: "4.1 Imagerie (Radio)", condition: () => hasDataFor('Radiologie'), action: () => setFlashFilters('Radiologie', '', '') },
              { name: "4.2 Laboratoire", condition: () => hasDataFor('Laboratoire'), action: () => setFlashFilters('Laboratoire', '', '') }
          ]
      },
      "FLASH_5": {
          title: "5. EXTERNES",
          targetId: "view-flash",
          items: [
              { name: "5.1 Urgences", condition: () => hasDataFor('Urgence'), action: () => setFlashFilters('Urgence', '', '') },
              { name: "5.2 Consultations", condition: () => hasDataFor('Consultation'), action: () => setFlashFilters('Consultation', '', '') },
              { name: "5.3 H√¥pital du Jour", condition: () => hasDataFor('H√¥pital du jour'), action: () => setFlashFilters('H√¥pital du jour', '', '') }
          ]
      },
      "FLASH_6": {
          title: "6. SERVICES ANNEXES",
          targetId: "view-flash",
          items: [
              { name: "6.1 M√©decine Nucl√©aire", condition: () => hasDataFor('M√©decine nucl√©aire'), action: () => setFlashFilters('M√©decine nucl√©aire', '', '') },
              { name: "6.2 Dialyse - S√©ances", condition: () => hasDataFor('Dialyse', 'Passage'), action: () => setFlashFilters('Dialyse', '', "Passage au niveau de l'HDJ") },
              { name: "6.3 Dialyse - Nouveaux Cas", condition: () => hasDataFor('Dialyse', 'Nouveaux cas'), action: () => setFlashFilters('Dialyse', '', "Nouveaux cas") }
          ]
      },
      "BUDGET_GROUP": {
          title: "7. CA vs BUDGET",
          targetId: "view-ca-budget",
          items: [
              { name: "7.1 Analyse CA (Tendance)", action: () => { if(typeof setBudgetMode === 'function') setBudgetMode('trend'); }, captureId: "view-ca-budget" },
              { name: "7.2 Comparaison vs Budget", action: () => { if(typeof setBudgetMode === 'function') setBudgetMode('comparison'); }, captureId: "view-ca-budget" }
          ]
      },
      "DEPENSES_GROUP": {
          title: "8. D√âPENSES",
          targetId: "view-depenses",
          items: [ 
              { name: "8.1 Vue Globale D√©penses", action: () => { if(typeof updateExpensesView === 'function') updateExpensesView(); }, captureId: "view-depenses", hideIds: ["depenseTable"] },
              { name: "8.2 Top B√©n√©ficiaires (Tableau)", action: () => { if(typeof updateExpensesView === 'function') updateExpensesView(); }, captureId: "depenseTable" }
          ]
      },
      "RECOUV_GROUP": {
          title: "9. RECOUVREMENT",
          targetId: "view-recouvrement",
          items: [
              { name: "9.1 Synth√®se & KPIs", action: () => forceSwitchFamily('Recouvrement', 'Dossiers non r√©gl√©s'), captureId: "view-recouvrement", hideIds: ["recouvTopTable", "blockClassifOrg", "blockClassifNature", "recouvPieBlock", "rowAlertsRecouv", "rowAlertsExped"] },
              { name: "9.2 R√©partition Organisme", action: () => forceSwitchFamily('Recouvrement', 'Dossiers non r√©gl√©s'), captureId: "view-recouvrement", hideIds: ["recouvChartBlock", "recouvTopTable", "rowAlertsRecouv", "rowAlertsExped"] },
              { name: "9.3 Top Factures", action: () => { forceSwitchFamily('Recouvrement', 'Dossiers non r√©gl√©s'); if(typeof renderTopFacturesTable==='function') renderTopFacturesTable('MONTANT'); }, captureId: "recouvTopTable" },
              { name: "9.4 Dossiers non sold√©s", action: () => forceSwitchFamily('Recouvrement', 'Dossiers non sold√©s') },
              { name: "9.5 Suivi des retours", action: () => forceSwitchFamily('Recouvrement', 'Suivi des retours') },
              { name: "9.6 Objectif vs R√©alisation", action: () => forceSwitchFamily('Recouvrement', 'Objectif vs R√©alisation') }
          ]
      },
      "EXPED_GROUP": {
          title: "10. EXP√âDITION",
          targetId: "view-recouvrement",
          items: [
              { name: "10.1 Synth√®se & KPIs", action: () => forceSwitchFamily('Exp√©dition', 'Dossiers non exp√©di√©s'), captureId: "view-recouvrement", hideIds: ["recouvTopTable", "blockClassifOrg", "blockClassifNature", "recouvPieBlock"] },
              { name: "10.2 R√©partition par Nature", action: () => forceSwitchFamily('Exp√©dition', 'Dossiers non exp√©di√©s'), captureId: "view-recouvrement", hideIds: ["recouvChartBlock", "recouvTopTable", "rowAlertsRecouv", "rowAlertsExped"] },
              { name: "10.3 Top Dossiers", action: () => forceSwitchFamily('Exp√©dition', 'Dossiers non exp√©di√©s'), captureId: "recouvTopTable" },
              { name: "10.4 Objectif vs R√©alisation", action: () => forceSwitchFamily('Exp√©dition', 'Objectif vs R√©alisation') }
          ]
      },
      "HONORAIRES_GROUP": {
          title: "11. HONORAIRES",
          targetId: "view-honoraires",
          items: [ 
              { name: "11.1 Vue Globale Honoraires", action: () => { if(typeof updateHonorairesView === 'function') updateHonorairesView('INIT'); }, captureId: "view-honoraires", hideIds: ["honoMainTable"] },
              { name: "11.2 Analyse TOP 10 M√©decins", action: () => { if(typeof updateHonoViewMode==='function') updateHonoViewMode('MEDECIN'); }, captureId: "honoMainTable" },
              { name: "11.3 TOP 10 Sp√©cialit√©s", action: () => { if(typeof updateHonoViewMode==='function') updateHonoViewMode('SPECIALITE'); }, captureId: "honoMainTable" },
              { name: "11.4 Balance √Çg√©e", action: () => { if(typeof updateHonoViewMode==='function') updateHonoViewMode('AGEING'); }, captureId: "honoMainTable" }
          ]
      },
      "RH_GROUP": {
        title: "12. RESSOURCES HUMAINES",
        targetId: "view-rh",
        items: [
            { 
                name: "12.1 Vue Globale RH", 
                action: () => { if(typeof enterRhMode_ === 'function') enterRhMode_(); }, 
                captureId: "view-rh" 
                // Nous avons retir√© 'hideIds' pour que tout soit captur√© en une seule fois
            }
        ]
    }
  };

  // =======================================================================
  //  4. UI & NAVIGATION
  // =======================================================================
  function toggleSidebar() { document.querySelector('.app-layout').classList.toggle('collapsed'); }
  function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      [window.kpiChartInstance, window.laboChartInstance, window.caChartInstance, window.recouvChartBarInstance, window.recouvChartPieInstance, window.expensesChartInstance, window.expensesPieInstance, window.chartHonoEvolInstance, window.chartHonoTypeOrgInstance, window.objRealChartInstance].forEach(chart => {
          if(chart && chart.options) {
              if(chart.options.scales?.x) chart.options.scales.x.grid.color = isDark ? '#444' : '#eee';
              if(chart.options.scales?.y) chart.options.scales.y.grid.color = isDark ? '#444' : '#eee';
              if(chart.options.plugins?.legend) chart.options.plugins.legend.labels.color = isDark ? '#ddd' : '#666';
              chart.update();
          }
      });
  }

// --- NAVIGATION ENTRE LES ONGLETS ---
  function switchTab(tabId) {
    // 1. Gestion des boutons (Votre code)
    document.querySelectorAll('.nav-tab-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = Array.from(document.querySelectorAll('.nav-tab-btn')).find(b => b.textContent.toLowerCase().includes(tabId.split('-')[0]));
    if(activeBtn) activeBtn.classList.add('active');

    // 2. Gestion de l'affichage (Votre code)
    // Assurez-vous que vos DIVs dans l'HTML ont bien des IDs comme "view-flash", "view-recouvrement", etc.
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    const target = document.getElementById('view-' + tabId);
    if (target) target.classList.add('active');

    const sidebar = document.getElementById('sidebar');
    const globalFilters = document.getElementById('globalFilters');
    
    // 3. Logique sp√©cifique par onglet (Votre code)
    if(tabId === 'flash') { 
        sidebar.style.display = 'flex'; globalFilters.style.visibility = 'visible';
        if(window.kpiChartInstance) window.kpiChartInstance.resize(); 
        if(typeof drawCharts === "function") drawCharts(); 
    } else if(tabId === 'ca-budget') {
        sidebar.style.display = 'none'; globalFilters.style.visibility = 'visible';
        if(window.caChartInstance) window.caChartInstance.resize();
        if(typeof updateCaBudgetView === "function") updateCaBudgetView();
    } else if(tabId === 'honoraires') {
        sidebar.style.display = 'none'; globalFilters.style.visibility = 'visible';
        if (!window.isHonorairesLoaded && typeof loadHonorairesData === "function") { loadHonorairesData(); window.isHonorairesLoaded = true; }
    } else { 
        sidebar.style.display = 'none'; globalFilters.style.visibility = 'visible';
        if(tabId === 'depenses' && typeof updateExpensesView === "function") updateExpensesView();
        if(tabId === 'recouvrement' && typeof updateRecouvDashboard === "function") updateRecouvDashboard();
    }

    // 4. === AJOUT POUR GRISER L'ENTIT√â ===
    // On force la r√©-application des r√®gles de s√©curit√© apr√®s un court d√©lai
    // pour s'assurer que les filtres charg√©s par les fonctions ci-dessus sont bien verrouill√©s.
    setTimeout(() => {
        if (typeof applyUserPermissions === 'function') {
            applyUserPermissions(); 
        }
    }, 200);
}
  
  window.onclick = function(event) { if (event.target == document.getElementById("historyModal")) document.getElementById("historyModal").style.display='none'; }
  
  function loadData() { 
      // Fonction conserv√©e pour le bouton "Actualiser"
      document.getElementById('loadingOverlay').style.display = 'flex';
      // On passe le contexte utilisateur actuel pour revalider
      const email = currentUserContext ? currentUserContext.email : null;
      google.script.run
          .withSuccessHandler(initializeDashboard) // R√©utilise la fonction init standard
          .withFailureHandler(showError)
          .getDashboardData(email); 
  }

  function updateData() { 
      document.getElementById('loadingOverlay').style.display = 'flex'; document.getElementById('loadingText').textContent = 'Mise √† jour...';
      const btn = document.getElementById('btnUpdate'); if(btn) btn.classList.add('spin-anim'); 
      google.script.run.withSuccessHandler(s => { 
          if(btn) btn.classList.remove('spin-anim'); if(s.includes('succ√®s')) loadData(); else { alert(s); document.getElementById('loadingOverlay').style.display='none'; }
      }).withFailureHandler(e => { if(btn) btn.classList.remove('spin-anim'); showError(e); }).clientNormalizeData(); 
  }

function initializeDashboard(data) { 
    // 1. Masquer le chargement
    const overlay = document.getElementById('loadingOverlay');
    if(overlay) overlay.style.display = 'none'; 
    
    // 2. Stockage des donn√©es et mise √† jour de l'UI du profil
    window.rawData = data; 
    if(data.userContext) {
        currentUserContext = data.userContext;
        
        // --- MISE √Ä JOUR DE L'INTERFACE UTILISATEUR DU HEADER ---
        const userName = currentUserContext.username || currentUserContext.email.split('@')[0];
        const nameEl = document.getElementById('connectedUserName');
        const posteEl = document.getElementById('connectedUserPoste');
        const photoEl = document.getElementById('connectedUserPhoto');
        
        if (nameEl) nameEl.textContent = userName.toUpperCase();
        if (posteEl) posteEl.textContent = currentUserContext.poste || 'Utilisateur';
        if (photoEl) {
            const photoUrl = currentUserContext.photo ? currentUserContext.photo : `https://ui-avatars.com/api/?name=${userName}&background=f8faff&color=363795&bold=true`;
            photoEl.src = photoUrl;
        }
    }

    // --- S√âCURIT√â RADICALE : On masque TOUS les contenus imm√©diatement ---
    const allParts = document.querySelectorAll('.dashboard-part');
    allParts.forEach(div => div.style.display = 'none');

    // 3. Traitement des donn√©es
    if (data && data.normalizedData) { 
        window.normalizedData = data.normalizedData.slice(1).filter(r => Array.isArray(r) && r.length>0 && r[0]); 
        window.extraContactData = data.contactData || {}; 
        window.extraCAData = data.caData || {}; 
        window.extraCapacityData = data.capacity || {}; 
    } else if (Array.isArray(data)) {
        window.normalizedData = data.slice(1).filter(r => Array.isArray(r) && r.length>0 && r[0]); 
    }
    
    // 4. Initialisation Filtres & S√©curit√©
    if(typeof populateFilters === "function") populateFilters(); 
    if(typeof applyUserPermissions === 'function') applyUserPermissions();
    
    const updateStatusEl = document.getElementById('updateStatus');
    if(updateStatusEl) updateStatusEl.textContent = 'Pr√™t';

    // =========================================================
    // 5. ROUTAGE ET REDIRECTION FORC√âE
    // =========================================================
    
    if (currentUserContext && currentUserContext.role === 'VIEWER_RECOUV') {
        console.log("üîí ROLE RECOUVREMENT : Activation forc√©e 'Dossiers non r√©gl√©s'");
        
        // Forcer l'onglet principal
        switchTab('recouvrement');

        // Forcer le sous-module
        setTimeout(() => {
            if (typeof switchFamily === 'function') {
                const btnTarget = Array.from(document.querySelectorAll('.nav-sub-btn')).find(b => 
                    b.textContent.includes("Dossiers non r√©gl√©s") || 
                    (b.getAttribute('onclick') && b.getAttribute('onclick').includes("Dossiers non r√©gl√©s"))
                );
                switchFamily('Recouvrement', 'Dossiers non r√©gl√©s', btnTarget);
                console.log("‚úÖ Routage Recouvrement appliqu√© via switchFamily");
            } else {
                console.warn("‚ö†Ô∏è Fonction switchFamily introuvable, tentative via clic simul√©.");
                const btnNonRegles = Array.from(document.querySelectorAll('button')).find(b => 
                    b.textContent.includes("Dossiers non r√©gl√©s")
                );
                if (btnNonRegles) btnNonRegles.click();
            }
        }, 300);

    } else {
        // --- COMPORTEMENT STANDARD (Flash) ---
        console.log("üè† ACCUEIL : Flash");
        if(typeof drawCharts === "function") drawCharts();
        switchTab('flash');
    }

    // 6. Chargement arri√®re-plan
    setTimeout(() => {
        if(typeof updateRecouvDashboard === 'function') { try { updateRecouvDashboard(); } catch(e){} }
    }, 1500);
}
  function showError(e) { document.getElementById('loadingOverlay').style.display = 'none'; alert("Erreur : " + e.message); }
  
  function updateMonthOptions() {
      const trim = document.getElementById('trimestre').value;
      const ms = document.getElementById('mois'); const cur = ms.value; ms.innerHTML = '<option value="">TOUT</option>';
      let list = window.monthOrder; if (trim && window.quarters[trim]) list = window.quarters[trim];
      list.forEach(m => ms.add(new Option(m, m)));
      ms.value = list.includes(cur) ? cur : '';
      const lm = document.getElementById('localMois'); if(lm) { lm.innerHTML = ms.innerHTML; lm.value = ms.value; }
  }

function syncFilters(src) {
      const he = document.getElementById('entite');
      const ht = document.getElementById('trimestre');
      const hm = document.getElementById('mois');
      const ha = document.getElementById('annee');

      const le = document.getElementById('localEntite');
      const lt = document.getElementById('localTrimestre');
      const lm = document.getElementById('localMois');
      const la = document.getElementById('localAnnee');

      const lbe = document.getElementById('localBudgetEntite');
      const lba = document.getElementById('localBudgetAnnee');
      const lbt = document.getElementById('localBudgetTrimestre');
      const lbm = document.getElementById('localBudgetMois');

      const re = document.getElementById('recouvFilterEntite');
      const ra = document.getElementById('recouvFilterAnnee');
      const rt = document.getElementById('recouvFilterTrim');
      const rm = document.getElementById('recouvFilterMois');

      const de = document.getElementById('depenseFilterEntite');
      const da = document.getElementById('depenseFilterAnnee'); 
      const dt = document.getElementById('depenseFilterTrim');
      const dm = document.getElementById('depenseFilterMois');

      const hoe = document.getElementById('honoFilterEntite');
      const hoa = document.getElementById('honoFilterAnnee');
      const hot = document.getElementById('honoFilterTrim');
      const hom = document.getElementById('honoFilterMois');
      
      // AJOUT POUR LE MODULE RH
      const rhe = document.getElementById('rhEntite');
      const rha = document.getElementById('rhAnnee');
      const rht = document.getElementById('rhTrimestre');
      const rhm = document.getElementById('rhMois');
      
      if(src === 'entite' || src === 'trimestre' || src === 'mois' || src === 'annee') { 
          if(le && he) le.value = he.value; 
          if(la && ha) la.value = ha.value; 
          if(lt && ht) { lt.value = ht.value; updateMonthOptions(); } 
          if(lm && hm) lm.value = hm.value; 

          if(lbe && he) lbe.value = he.value;
          if(lba && ha) lba.value = ha.value;
          if(lbt && ht) lbt.value = ht.value;
          if(lbm && hm) lbm.value = hm.value;

          if(re && he) { re.value = he.value; if(re.onchange) re.onchange(); } 
          if(ra && ha) { ra.value = ha.value; }
          if(rt && ht) { rt.value = ht.value; if(rt.onchange) rt.onchange(); } 
          if(rm && hm) { rm.value = hm.value; }

          if(de && he) { de.value = he.value; if(de.onchange) de.onchange(); }
          if(dt && ht) { dt.value = ht.value; if(dt.onchange) dt.onchange(); }
          if(dm && hm) { dm.value = hm.value; }
          if(src === 'annee' && ha && da) { da.value = ha.value; if(da.onchange) da.onchange(); }

          if(hoe && he) { hoe.value = he.value; if(hoe.onchange) hoe.onchange(); }
          if(hoa && ha) { hoa.value = ha.value; }
          if(hot && ht) { hot.value = ht.value; if(hot.onchange) hot.onchange(); }
          if(hom && hm) { hom.value = hm.value; }
          
          // SYNCHRONISATION RH
          if(rhe && he) { rhe.value = he.value; if(rhe.onchange) rhe.onchange(); }
          if(rha && ha) { rha.value = ha.value; if(rha.onchange) rha.onchange(); }
          if(rht && ht) { rht.value = ht.value; if(rht.onchange) rht.onchange(); }
          if(rhm && hm) { rhm.value = hm.value; if(rhm.onchange) rhm.onchange(); }
      }
      
      if(src && src.startsWith('local')) { 
          if(src==='localEntite' && he && le) he.value = le.value; 
          if(src==='localAnnee' && ha && la) ha.value = la.value;
          if(src==='localTrimestre' && ht && lt) { ht.value = lt.value; updateMonthOptions(); } 
          if(src==='localMois' && hm && lm) hm.value = lm.value; 
      }
      
      const at = document.querySelector('.view-section.active');
      if(at) {
          if(at.id === 'view-ca-budget' && typeof updateCaBudgetView === "function") updateCaBudgetView();
          else if (at.id === 'view-depenses' && typeof updateExpensesView === "function") updateExpensesView();
          else if (at.id === 'view-recouvrement' && typeof updateRecouvDashboard === "function") updateRecouvDashboard();
          else if (at.id === 'view-honoraires' && typeof updateHonorairesView === "function") updateHonorairesView();
          else if (at.id === 'view-flash' && typeof drawCharts === "function") drawCharts(); 
          else if (at.id === 'view-rh' && typeof drawCharts === "function") drawCharts();
          // RH est g√©r√© par ses propres listeners (onchange)
      }
  }

  // =======================================================================
  //  MOTEUR D'EXPORTATION AVANC√â
  // =======================================================================

  function applyGlobalFiltersToView(viewId) {
      const gEntite = document.getElementById('entite').value;
      const gTrim = document.getElementById('trimestre').value;
      const gMois = document.getElementById('mois').value;
      const gAnnee = document.getElementById('annee').value;

      const setVal = (id, val) => { 
          const el = document.getElementById(id); 
          if(el) { el.value = val; el.dispatchEvent(new Event('change')); } 
      };
      
      try {
          if (viewId === 'view-flash') { setVal('localEntite', gEntite); setVal('localAnnee', gAnnee); setVal('localTrimestre', gTrim); setVal('localMois', gMois); } 
          else if (viewId === 'view-ca-budget') { setVal('localBudgetEntite', gEntite); setVal('localBudgetTrimestre', gTrim); setVal('localBudgetMois', gMois); } 
          else if (viewId === 'view-recouvrement') { setVal('recouvFilterEntite', gEntite); setVal('recouvFilterTrim', gTrim); setVal('recouvFilterMois', gMois); setVal('recouvFilterAnnee', gAnnee); } 
          else if (viewId === 'view-depenses') { setVal('depenseFilterEntite', gEntite); setVal('depenseFilterTrim', gTrim); setVal('depenseFilterMois', gMois); } 
          else if (viewId === 'view-honoraires') { setVal('honoFilterEntite', gEntite); setVal('honoFilterTrim', gTrim); setVal('honoFilterMois', gMois); setVal('honoFilterAnnee', gAnnee); }
          else if (viewId === 'view-rh') { setVal('rhEntite', gEntite); setVal('rhTrimestre', gTrim); setVal('rhMois', gMois); setVal('rhAnnee', gAnnee); }
      } catch(e) { console.error(e); }
  }

  function toggleGroupList(header) {
      const body = header.nextElementSibling;
      const icon = header.querySelector('.toggle-icon');
      if (body.style.display === 'block') { body.style.display = 'none'; icon.classList.remove('rotated'); } 
      else { body.style.display = 'block'; icon.classList.add('rotated'); }
  }
  
  function moveUp(btn) { 
      const itemRow = btn.closest('.export-item');
      if (itemRow) { if (itemRow.previousElementSibling) itemRow.parentNode.insertBefore(itemRow, itemRow.previousElementSibling); }
      else { const group = btn.closest('.export-group'); if (group && group.previousElementSibling) group.parentNode.insertBefore(group, group.previousElementSibling); }
  }
  function moveDown(btn) { 
      const itemRow = btn.closest('.export-item');
      if (itemRow) { if (itemRow.nextElementSibling) itemRow.parentNode.insertBefore(itemRow.nextElementSibling, itemRow); }
      else { const group = btn.closest('.export-group'); if (group && group.nextElementSibling) group.parentNode.insertBefore(group.nextElementSibling, group); }
  }

  function openGlobalExportModal() {
      const modal = document.getElementById('exportModal');
      const container = document.getElementById('exportCheckboxesArea');
      container.innerHTML = ''; 

      Object.keys(EXPORT_CONFIG).forEach(key => {
          const config = EXPORT_CONFIG[key];
          const availableItems = config.items.filter(item => !item.condition || item.condition());

          if (availableItems.length === 0) return; 

          const groupDiv = document.createElement('div');
          groupDiv.className = 'export-group';
          
          const headerDiv = document.createElement('div');
          headerDiv.className = 'export-group-header';
          headerDiv.innerHTML = `
              <i class="fas fa-chevron-right toggle-icon" onclick="toggleGroupList(this.parentNode)"></i>
              <div class="export-group-title">
                  <input type="checkbox" class="export-checkbox group-master" data-group="${key}" checked onclick="toggleGroup(this); event.stopPropagation();">
                  <span onclick="toggleGroupList(this.parentNode.parentNode)">${config.title}</span>
              </div>
              <div class="export-group-controls">
                  <div class="sort-btn" onclick="moveUp(this)" title="Monter Groupe"><i class="fas fa-arrow-up"></i></div>
                  <div class="sort-btn" onclick="moveDown(this)" title="Descendre Groupe"><i class="fas fa-arrow-down"></i></div>
              </div>
          `;
          groupDiv.appendChild(headerDiv);

          const bodyDiv = document.createElement('div');
          bodyDiv.className = 'export-group-body';
          
          const currentView = document.querySelector('.view-section.active').id;
          if(config.targetId === currentView) { bodyDiv.style.display = 'block'; headerDiv.querySelector('.toggle-icon').classList.add('rotated'); }

          availableItems.forEach((item, idx) => {
              const originalIndex = config.items.indexOf(item);
              const itemDiv = document.createElement('div');
              itemDiv.className = 'export-item';
              itemDiv.innerHTML = `
                  <div style="flex:1; display:flex; align-items:center;">
                      <input type="checkbox" class="export-checkbox item-check" value="${key}|${originalIndex}" data-title="${item.name}" data-group-ref="${key}" checked>
                      <span>${item.name}</span>
                  </div>
                  <div class="export-group-controls" style="opacity:0.5; transform:scale(0.8);">
                      <div class="sort-btn" onclick="moveUp(this)"><i class="fas fa-arrow-up"></i></div>
                      <div class="sort-btn" onclick="moveDown(this)"><i class="fas fa-arrow-down"></i></div>
                  </div>
              `;
              bodyDiv.appendChild(itemDiv);
          });
          groupDiv.appendChild(bodyDiv);
          container.appendChild(groupDiv);
      });
      modal.style.display = 'flex';
  }

  function toggleGroup(master) {
      const groupContainer = master.closest('.export-group');
      const inputs = groupContainer.querySelectorAll(`.item-check`);
      inputs.forEach(inp => inp.checked = master.checked);
  }

  async function processDynamicExport(format) {
      const container = document.getElementById('exportCheckboxesArea');
      const checkboxes = Array.from(container.querySelectorAll('.item-check:checked'));
      if (checkboxes.length === 0) { alert("S√©lectionnez au moins un √©l√©ment."); return; }
      
      const includeCover = document.getElementById('chkCover').checked;
      const includeSeparators = document.getElementById('chkSeparators').checked;
      const modal = document.getElementById('exportModal');
      const loadingHeader = modal.querySelector('h3');
      const originalText = loadingHeader.innerHTML;
      loadingHeader.innerHTML = `<i class="fas fa-spinner fa-spin"></i> G√©n√©ration...`;

      let pptx, pdf;
      const entiteVal = document.getElementById('entite').value;
      const entiteName = entiteVal === "" ? "REGION GRAND SUD" : entiteVal; 
      
      let respName = "", dirMedName = "";
      if (entiteVal && window.extraContactData[entiteVal]) {
          respName = window.extraContactData[entiteVal].respExploit || "";
          dirMedName = window.extraContactData[entiteVal].dirMedical || "";
      }

      const periodName = (document.getElementById('mois').value ? document.getElementById('mois').value : (document.getElementById('trimestre').value || "Ann√©e")) + " " + new Date().getFullYear();
      const dateGen = new Date().toLocaleDateString('fr-FR');

      if (format === 'ppt') {
          pptx = new PptxGenJS();
          pptx.layout = 'LAYOUT_16x9';
          pptx.title = `Rapport - ${entiteName}`;
          if(includeCover) {
              let slide = pptx.addSlide(); slide.background = { color: "F8FAFF" };
              slide.addShape(pptx.ShapeType.rect, { x:0, y:0, w:3, h:'100%', fill:'363795' }); 
              slide.addText("RAPPORT D'ACTIVIT√â", { x:3.5, y:2.0, fontSize:40, color:'363795', bold:true });
              slide.addText(entiteName, { x:3.5, y:3.0, fontSize:28, color:'E67E22', bold:true });
              slide.addText(periodName, { x:3.5, y:3.7, fontSize:20, color:'666666' });
              
              if(respName || dirMedName) {
                  slide.addText("MANAGEMENT", { x:3.5, y:5.0, fontSize:14, color:'363795', bold:true });
                  if(respName) slide.addText("Resp. Exploitation : " + respName, { x:3.5, y:5.4, fontSize:12, color:'555555' });
                  if(dirMedName) slide.addText("Dir. M√©dical : " + dirMedName, { x:3.5, y:5.8, fontSize:12, color:'555555' });
              }
              slide.addText(`G√©n√©r√© le ${dateGen}`, { x:0.5, y:7, fontSize:12, color:'FFFFFF' });
              
              let summarySlide = pptx.addSlide();
              summarySlide.addText("SOMMAIRE D√âTAILL√â", { x:0.5, y:0.5, fontSize:24, color:'363795', bold:true, underline:true });
              let yPos = 1.5; let currentSection = "";
              checkboxes.forEach(cb => {
                  let groupKey = cb.getAttribute('data-group-ref');
                  let sectionTitle = EXPORT_CONFIG[groupKey].title;
                  if (sectionTitle !== currentSection) {
                      summarySlide.addText(sectionTitle.toUpperCase(), { x:0.5, y:yPos, fontSize:16, color:'E67E22', bold:true });
                      yPos += 0.5; currentSection = sectionTitle;
                  }
                  let subTitle = cb.getAttribute('data-title');
                  summarySlide.addText("   ‚Ä¢ " + subTitle, { x:1, y:yPos, fontSize:14, color:'333' });
                  yPos += 0.4;
                  if(yPos > 6.5) { summarySlide = pptx.addSlide(); yPos = 1.0; }
              });
          }
      } else {
          window.jsPDF = window.jspdf.jsPDF;
          pdf = new jsPDF('l', 'mm', 'a4');
          const w = pdf.internal.pageSize.getWidth(); const h = pdf.internal.pageSize.getHeight();

          if (includeCover) {
              pdf.setFillColor(245, 247, 250); pdf.rect(0, 0, w, h, 'F');
              pdf.setFillColor(54, 55, 149); pdf.rect(0, 0, 15, h, 'F');
              pdf.setFillColor(230, 126, 34); pdf.rect(15, 60, 5, 40, 'F');

              pdf.setTextColor(54, 55, 149); pdf.setFontSize(40); pdf.setFont("helvetica", "bold");
              pdf.text("RAPPORT", 30, 75); pdf.text("D'ACTIVIT√â", 30, 90);
              
              pdf.setTextColor(230, 126, 34); pdf.setFontSize(28);
              pdf.text(entiteName.toUpperCase(), 30, 115);
              
              pdf.setTextColor(100, 100, 100); pdf.setFontSize(18); pdf.setFont("helvetica", "normal");
              pdf.text(periodName, 30, 130);
              
              if(respName || dirMedName) {
                  pdf.setFontSize(12); pdf.setTextColor(54, 55, 149); pdf.setFont("helvetica", "bold");
                  pdf.text("MANAGEMENT", 30, 160);
                  pdf.setFontSize(11); pdf.setTextColor(80, 80, 80); pdf.setFont("helvetica", "normal");
                  let yC = 168;
                  if(respName) { pdf.text("Responsable Exploitation : " + respName, 30, yC); yC+=7; }
                  if(dirMedName) { pdf.text("Directeur M√©dical : " + dirMedName, 30, yC); }
              }

              pdf.setTextColor(255, 255, 255); pdf.setFontSize(10);
              pdf.text(`G√©n√©r√© le ${dateGen}`, 10, h - 10);

              pdf.addPage();
              pdf.setFillColor(54, 55, 149); pdf.rect(0, 0, w, 20, 'F');
              pdf.setTextColor(255, 255, 255); pdf.setFontSize(16); pdf.setFont("helvetica", "bold");
              pdf.text("SOMMAIRE D√âTAILL√â", 10, 14);

              let yPos = 40; let pageCounter = 3; 
              let lastGroup = "";
              
              pdf.setTextColor(60, 60, 60); pdf.setFontSize(12);
              checkboxes.forEach(cb => {
                  let groupKey = cb.getAttribute('data-group-ref');
                  let sectionTitle = EXPORT_CONFIG[groupKey].title;
                  
                  if (yPos > 180) { pdf.addPage(); yPos = 30; }
                  
                  if(groupKey !== lastGroup) {
                      yPos += 8;
                      pdf.setTextColor(230, 126, 34); pdf.setFontSize(13); pdf.setFont("helvetica", "bold");
                      pdf.text(sectionTitle.toUpperCase(), 20, yPos);
                      yPos += 8;
                      lastGroup = groupKey;
                      pdf.setTextColor(60, 60, 60); pdf.setFontSize(11); pdf.setFont("helvetica", "normal");
                      if(includeSeparators) pageCounter++;
                  }

                  let title = cb.getAttribute('data-title');
                  pdf.text(title, 30, yPos);
                  pdf.setDrawColor(200, 200, 200); pdf.setLineDash([1, 1], 0);
                  pdf.line(35 + pdf.getStringUnitWidth(title)*4, yPos, w-30, yPos);
                  pdf.text(String(pageCounter), w-25, yPos);
                  yPos += 7; pageCounter++; 
              });
          }
      }

      let lastGroupKey = "";
      let processedCount = 0;
      let currentPageNum = includeCover ? 3 : 1;

      for (let cb of checkboxes) {
          const [groupKey, itemIndex] = cb.value.split('|');
          const config = EXPORT_CONFIG[groupKey];
          const item = config.items[itemIndex];
          const targetEl = document.getElementById(item.captureId || config.targetId);

          if (includeSeparators && groupKey !== lastGroupKey) {
              if (format === 'pdf') {
                  pdf.addPage();
                  pdf.setFillColor(54, 55, 149); pdf.rect(0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight(), 'F');
                  pdf.setTextColor(255, 255, 255); pdf.setFontSize(36); pdf.setFont("helvetica", "bold");
                  pdf.text(config.title.toUpperCase(), pdf.internal.pageSize.getWidth()/2, pdf.internal.pageSize.getHeight()/2, { align: 'center' });
                  pdf.setFontSize(10); pdf.text("Page " + currentPageNum, pdf.internal.pageSize.getWidth()-20, pdf.internal.pageSize.getHeight()-10);
                  currentPageNum++;
              } else {
                  let s = pptx.addSlide(); s.background = { color: "EEEEEE" };
                  s.addText(config.title.toUpperCase(), { x:0, y:'45%', w:'100%', align:'center', fontSize:30, color:'363795', bold:true });
              }
              lastGroupKey = groupKey;
          }

          document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
          const parentView = targetEl.closest('.view-section') || targetEl;
          parentView.classList.add('active'); parentView.style.display = 'block';
          
          applyGlobalFiltersToView(config.targetId);
          if (item.action) item.action();

          const elsToHide = [];
          if(item.hideIds) {
              item.hideIds.forEach(hid => {
                  const el = document.getElementById(hid);
                  if(el && el.style.display !== 'none') {
                      el.setAttribute('data-original-display', el.style.display);
                      el.style.display = 'none';
                      elsToHide.push(el);
                  }
              });
          }

          await new Promise(r => setTimeout(r, 2000)); // Attente rendu augment√©e

          try {
              // ZOOM MAXIMAL ET MARGES R√âDUITES
              const canvas = await html2canvas(targetEl, { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff', scrollX:0, scrollY:0 });
              const imgData = canvas.toDataURL('image/png');

              if (format === 'pdf') {
                  pdf.addPage();
                  const w = pdf.internal.pageSize.getWidth(); const h = pdf.internal.pageSize.getHeight();
                  
                  pdf.setFillColor(240, 240, 240); pdf.rect(0, 0, w, 12, 'F');
                  pdf.setTextColor(54, 55, 149); pdf.setFontSize(10); pdf.setFont("helvetica", "bold");
                  pdf.text(`${config.title} > ${item.name}`, 10, 8);
                  pdf.setTextColor(100, 100, 100); pdf.setFontSize(10); pdf.setFont("helvetica", "normal");
                  pdf.text(`${entiteName} | ${periodName}`, w - 60, 8);

                  const imgProps = pdf.getImageProperties(imgData);
                  
                  // OPTIMISATION IMAGE (Marges r√©duites √† 5mm)
                  let margin = 5; 
                  let availW = w - (margin * 2);
                  let availH = h - 20; 
                  
                  let finalW = availW; 
                  let finalH = (imgProps.height * finalW) / imgProps.width;
                  
                  if(finalH > availH) { 
                      finalH = availH; 
                      finalW = (imgProps.width * finalH) / imgProps.height; 
                  }
                  
                  // Centrage vertical
                  let xPos = (w - finalW) / 2;
                  let yPos = 12 + ((availH - finalH) / 2); 
                  
                  pdf.addImage(imgData, 'PNG', xPos, yPos, finalW, finalH);

                  pdf.setFontSize(9); pdf.setTextColor(150, 150, 150);
                  pdf.text(`Page ${currentPageNum}`, w - 20, h - 5);
                  currentPageNum++;
              } else {
                  let slide = pptx.addSlide();
                  slide.addText(item.name, { x:0.2, y:0.2, fontSize:18, color:'363795', bold:true });
                  slide.addImage({ data: imgData, x:0.2, y:0.8, w:'95%', h:'85%', sizing: { type: 'contain', w: '95%', h: '85%' } });
              }
          } catch(e) { console.error(e); } 
          finally {
              elsToHide.forEach(el => el.style.display = el.getAttribute('data-original-display') || 'block');
          }

          processedCount++;
          loadingHeader.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Export... ${Math.round(processedCount / checkboxes.length * 100)}%`;
      }

      const fileName = `Rapport_${entiteName.replace(/\s+/g,'_')}_${dateGen.replace(/\//g,'-')}`;
      if (format === 'pdf') pdf.save(fileName + ".pdf"); else pptx.writeFile({ fileName: fileName + ".pptx" });

      loadingHeader.innerHTML = originalText;
      if(container) container.style.display = 'block'; // Pas s√ªr de ce s√©lecteur, mais s√©curit√©
      modal.style.display = 'none';
  }

  function selectFamily(family) { 
      document.querySelectorAll('#familyButtons button').forEach(btn => { 
          btn.classList.toggle('active', btn.getAttribute('data-family') === family); 
      }); 
      const labelElement = document.querySelector('label[for="element"]');
      if(labelElement) { labelElement.textContent = (family === 'Hospitalisation') ? 'Service' : '√âl√©ment'; }
      
      populateSousFamille(family); 
      populateEntiteFilter(family); 
      
      const lEntite = document.getElementById('localEntite'); 
      const entiteSelect = document.getElementById('entite');
      if(lEntite && entiteSelect) { lEntite.innerHTML = entiteSelect.innerHTML; lEntite.value = entiteSelect.value; }

      const lAnnee = document.getElementById('localAnnee');
      const anneeSelect = document.getElementById('annee');
      if(lAnnee && anneeSelect) { lAnnee.innerHTML = anneeSelect.innerHTML; lAnnee.value = anneeSelect.value; }
      
      const lMois = document.getElementById('localMois'); const moisSelect = document.getElementById('mois');
      if(moisSelect.options.length <= 1) { 
          moisSelect.innerHTML = '<option value="">TOUT</option>'; 
          monthOrder.forEach(m => moisSelect.add(new Option(m, m)));
      }
      if(lMois) { lMois.innerHTML = moisSelect.innerHTML; lMois.value = moisSelect.value; }
      
      const lTrim = document.getElementById('localTrimestre'); const trimSelect = document.getElementById('trimestre');
      if(trimSelect.options.length <= 1) { 
          trimSelect.innerHTML = '<option value="">TOUT</option><option value="T1">T1</option><option value="T2">T2</option><option value="T3">T3</option><option value="T4">T4</option>'; 
      }
      if(lTrim) { lTrim.innerHTML = trimSelect.innerHTML; lTrim.value = trimSelect.value; }
  }


// --- GESTION FILTRE ENTIT√â (FLASH) ---
function populateEntiteFilter(selectedFamille) { 
    const entiteSelect = document.getElementById('entite'); 
    if(!entiteSelect) return;

    const currentSelection = entiteSelect.value; 
    
    // Filtrage des donn√©es
    const familyFilteredData = normalizedData.filter(r => r[2].toString() === selectedFamille); 
    const newEntiteSet = new Set(familyFilteredData.map(r => r[0].toString()).filter(v => v.trim() !== '')); 
    
    if(newEntiteSet.has("HIA") && newEntiteSet.has("CIOA")) newEntiteSet.add("HIA CIOA");

    // Reconstruction du Select
    entiteSelect.innerHTML = '<option value="">TOUT</option>'; 
    Array.from(newEntiteSet).sort().forEach(item => entiteSelect.add(new Option(item, item))); 
    
    // Restauration valeur
    entiteSelect.value = (currentSelection && newEntiteSet.has(currentSelection)) ? currentSelection : ''; 

    // IMPORTANT : R√©-application imm√©diate de la s√©curit√©
    if (typeof applyUserPermissions === 'function') {
        applyUserPermissions(); 
    }
}

  function populateSousFamille(selectedFamille) { 
      const sousFamilleSelect = document.getElementById('sousFamille'); 
      const currentSelection = sousFamilleSelect.value; 
      const targetData = normalizedData.filter(r => r[2].toString() === selectedFamille); 
      const sousFamilleSet = new Set(targetData.map(r => r[3].toString()).filter(isFilterValueValid)); 
      sousFamilleSelect.innerHTML = '<option value="">TOUT</option>'; 
      Array.from(sousFamilleSet).sort().forEach(item => sousFamilleSelect.add(new Option(item, item))); 
      sousFamilleSelect.value = (currentSelection && sousFamilleSet.has(currentSelection)) ? currentSelection : ''; 
      populateElementFilter(selectedFamille, sousFamilleSelect.value); 
  }

  function populateElementFilter(selectedFamille, selectedSousFamille) { 
      const elementSelect = document.getElementById('element'); 
      const currentSelection = elementSelect.value; 
      const filteredData = normalizedData.filter(r => r[2].toString() === selectedFamille && (!selectedSousFamille || r[3].toString() === selectedSousFamille)); 
      const elementSet = new Set(filteredData.map(r => r[4].toString()).filter(isFilterValueValid)); 
      elementSelect.innerHTML = '<option value="">TOUT</option>'; 
      Array.from(elementSet).sort().forEach(item => elementSelect.add(new Option(item, item))); 
      elementSelect.value = (currentSelection && elementSet.has(currentSelection)) ? currentSelection : ''; 
      drawCharts(); 
  }
</script>