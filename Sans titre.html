<script>
  Chart.register(ChartDataLabels);
  Chart.defaults.color = '#333';
  
  window.rawData = {}; 
  window.normalizedData = []; 
  window.extraContactData = {}; 
  window.extraCAData = {}; 
  window.extraCapacityData = {}; 
  let currentUserContext = null; 

  window.kpiChartInstance = null; 
  window.laboChartInstance = null; 
  window.historyChartInstance = null;
  window.caChartInstance = null;
  window.isHonorairesLoaded = false;
  
  window.monthOrder = ["JAN", "FEV", "MAR", "AVR", "MAI", "JUIN", "JUIL", "AOU", "SEP", "OCT", "NOV", "DEC"];
  window.quarters = { "T1": ["JAN", "FEV", "MAR"], "T2": ["AVR", "MAI", "JUIN"], "T3": ["JUIL", "AOU", "SEP"], "T4": ["OCT", "NOV", "DEC"] };
  window.monthToQuarterMap = { "JAN":"T1", "FEV":"T1", "MAR":"T1", "AVR":"T2", "MAI":"T2", "JUIN":"T2", "JUIL":"T3", "AOU":"T3", "SEP":"T3", "OCT":"T4", "NOV":"T4", "DEC":"T4" };
  window.ENTITY_ORDER = ["HIA CIOA", "CIT", "CID", "PIL", "HPG", "ALHIKMA"];
  const FAMILIES_ORDER = ["Hospitalisation", "Bloc", "Salle de cathé et rythmologie", "Radiothérapie", "Chimiothérapie", "Médecine nucléaire", "Dialyse", "Hôpital du jour", "Radiologie", "Laboratoire", "Consultation", "Urgence", "Centre de rééducation", "Curiethérapie et CHIP"];
  
  window.isFilterValueValid = function(v) { return v !== null && v !== undefined && String(v).trim() !== '' && String(v).trim() !== '-'; };
  window.formatValue = function(v) { if (v === 'N/A' || v === '--' || v == null || isNaN(v)) return '--'; return Math.round(parseFloat(v)).toLocaleString('fr-FR'); };
  window.formatMoney = function(v) { return (v === undefined || v === null) ? "0" : Math.round(v).toLocaleString('fr-FR') + " "; };
  window.formatDecimal = function(value) { if (value === 'N/A' || value === '--' || value == null || isNaN(value) || !isFinite(value)) return '--'; return parseFloat(value).toLocaleString('fr-FR', { minimumFractionDigits: 1, maximumFractionDigits: 1 }); };

  window.applyUserPermissions = function(role, entity) {
      role = role || (window.currentUserContext ? window.currentUserContext.role : null);
      entity = entity || (window.currentUserContext ? window.currentUserContext.entity : null);
      window.currentUserContext = { ...window.currentUserContext, role: role, entity: entity };

      const isAdmin = (role === 'ADMIN');
      
      if (!isAdmin) {
          const importIds = ['btnUpdate', 'recouvImportZone', 'importZone', 'btnImport', 'fileInput', 'btnUpload', 'depenseImportZone', 'honoImportZone'];
          importIds.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });

          document.querySelectorAll('input[type="file"]').forEach(el => {
              el.style.display = 'none';
              if(el.parentElement && el.parentElement.tagName === 'LABEL') el.parentElement.style.display = 'none';
          });

          document.querySelectorAll('button').forEach(btn => {
              const text = (btn.getAttribute('onclick') || "") + " " + (btn.textContent || "");
              if (text.toLowerCase().includes('import') || text.toLowerCase().includes('upload') || text.includes('Charger le fichier')) {
                  btn.style.display = 'none';
              }
          });

          document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
          const btnObj = document.querySelector('button[onclick="triggerObjRealImport()"]');
          if(btnObj) btnObj.style.display = 'none';
      } else {
           document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
      }

      if (role === 'VIEWER_ENTITY' && entity) {
          const filterIds = ['entite', 'localEntite', 'localBudgetEntite', 'recouvFilterEntite', 'depenseFilterEntite', 'honoFilterEntite', 'rhEntite', 'expedFilterEntite'];
          filterIds.forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                  el.value = entity; 
                  if (el.value !== entity) {
                      const opt = document.createElement('option');
                      opt.value = entity; opt.text = entity; el.add(opt); el.value = entity;
                  }
                  el.disabled = true;
                  el.style.backgroundColor = "#e5e7eb";
                  el.style.color = "#6b7280";
                  el.style.opacity = "0.7";
                  el.style.cursor = "not-allowed";
              }
          });
          const headerTitle = document.querySelector('header h2');
          if(headerTitle && !document.getElementById('entityBadge')) {
              headerTitle.innerHTML += ` <span id="entityBadge" style="font-size:0.6em; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:10px; vertical-align:middle;">${entity}</span>`;
          }
      }

      if (role === 'VIEWER_RECOUV') {
          ['flash', 'budget', 'depenses', 'rh', 'honoraires'].forEach(tab => {
              const selector = `button[onclick*="${tab}"]`;
              document.querySelectorAll(selector).forEach(b => b.style.display = 'none');
          });
          const sb = document.getElementById('sidebar');
          if(sb) sb.style.display = 'none';
      }
  };

  document.addEventListener('DOMContentLoaded', () => {
      console.log("Application prête à la connexion.");
  });

  function hasDataFor(familleKeyword, elementKeyword = null) {
      const entite = document.getElementById('entite') ? document.getElementById('entite').value : '';
      return window.normalizedData.some(row => {
          if (entite && row[0] !== entite) return false;
          const rowFam = String(row[2] || "").toUpperCase();
          const rowSub = String(row[3] || "").toUpperCase();
          const rowEl = String(row[4] || "").toUpperCase();

          if (!rowFam.includes(familleKeyword.toUpperCase())) return false;
          if (elementKeyword) {
              const kw = elementKeyword.toUpperCase();
              return rowSub.includes(kw) || rowEl.includes(kw);
          }
          return true;
      });
  }

  function setFlashFilters(fam, subFam, element) {
      if(typeof selectFamily === 'function') selectFamily(fam);
      setTimeout(() => {
          const sfSelect = document.getElementById('sousFamille');
          if(subFam && sfSelect) {
              let foundSF = false;
              for(let opt of sfSelect.options) {
                  if(opt.value.toUpperCase().includes(subFam.toUpperCase())) {
                      sfSelect.value = opt.value;
                      sfSelect.dispatchEvent(new Event('change'));
                      foundSF = true; break;
                  }
              }
              if(!foundSF) { sfSelect.value = ""; sfSelect.dispatchEvent(new Event('change')); }
          } else if (sfSelect) {
              sfSelect.value = ""; sfSelect.dispatchEvent(new Event('change'));
          }

          if(element) {
              setTimeout(() => {
                  const elSelect = document.getElementById('element');
                  if(elSelect) {
                      for(let opt of elSelect.options) {
                          if(opt.value.toUpperCase().includes(element.toUpperCase())) {
                              elSelect.value = opt.value;
                              elSelect.dispatchEvent(new Event('change'));
                              break;
                          }
                      }
                  }
              }, 300);
          }
      }, 150);
  }

  function forceSwitchFamily(main, sub) { if(typeof switchFamily === 'function') switchFamily(main, sub); }

  const EXPORT_CONFIG = {
      "FLASH_1": { title: "1. HOSPITALISATION", targetId: "view-flash", items: [] },
      "BUDGET_GROUP": { title: "2. CA vs BUDGET", targetId: "view-ca-budget", items: [] },
      "DEPENSES_GROUP": { title: "3. DÉPENSES", targetId: "view-depenses", items: [] },
      "RECOUV_GROUP": { title: "4. RECOUVREMENT", targetId: "view-recouvrement", items: [] },
      "EXPED_GROUP": { title: "5. EXPÉDITION", targetId: "view-recouvrement", items: [] },
      "HONORAIRES_GROUP": { title: "6. HONORAIRES", targetId: "view-honoraires", items: [] },
      "RH_GROUP": { title: "7. RESSOURCES HUMAINES", targetId: "view-rh", items: [] }
  };

  function toggleSidebar() { document.querySelector('.app-layout').classList.toggle('collapsed'); }
  function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      [window.kpiChartInstance, window.laboChartInstance, window.caChartInstance, window.recouvChartBarInstance, window.recouvChartPieInstance, window.expensesChartInstance, window.expensesPieInstance, window.chartHonoEvolInstance, window.chartHonoTypeOrgInstance, window.objRealChartInstance].forEach(chart => {
          if(chart && chart.options) {
              if(chart.options.scales?.x) chart.options.scales.x.grid.color = isDark ? '#444' : '#eee';
              if(chart.options.scales?.y) chart.options.scales.y.grid.color = isDark ? '#444' : '#eee';
              if(chart.options.plugins?.legend) chart.options.plugins.legend.labels.color = isDark ? '#ddd' : '#666';
              chart.update();
          }
      });
  }

  function switchTab(tabId) {
      document.querySelectorAll('.nav-tab-btn').forEach(btn => btn.classList.remove('active'));
      const activeBtn = Array.from(document.querySelectorAll('.nav-tab-btn')).find(b => b.textContent.toLowerCase().includes(tabId.split('-')[0]));
      if(activeBtn) activeBtn.classList.add('active');

      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      const target = document.getElementById('view-' + tabId);
      if (target) target.classList.add('active');

      const sidebar = document.getElementById('sidebar');
      const globalFilters = document.getElementById('globalFilters');
      
      if(tabId === 'flash') { 
          sidebar.style.display = 'flex'; globalFilters.style.visibility = 'visible';
          if(window.kpiChartInstance) window.kpiChartInstance.resize(); 
          if(typeof drawCharts === "function") drawCharts(); 
      } else if(tabId === 'ca-budget') {
          sidebar.style.display = 'none'; globalFilters.style.visibility = 'visible';
          if(window.caChartInstance) window.caChartInstance.resize();
          if(typeof updateCaBudgetView === "function") updateCaBudgetView();
      } else if(tabId === 'honoraires') {
          sidebar.style.display = 'none'; globalFilters.style.visibility = 'visible';
          if (!window.isHonorairesLoaded && typeof loadHonorairesData === "function") { loadHonorairesData(); window.isHonorairesLoaded = true; }
      } else { 
          sidebar.style.display = 'none'; globalFilters.style.visibility = 'visible';
          if(tabId === 'depenses' && typeof updateExpensesView === "function") updateExpensesView();
          if(tabId === 'recouvrement' && typeof updateRecouvDashboard === "function") updateRecouvDashboard();
      }

      setTimeout(() => {
          if (typeof applyUserPermissions === 'function') {
              applyUserPermissions(); 
          }
      }, 200);
  }
  
  window.onclick = function(event) { if (event.target == document.getElementById("historyModal")) document.getElementById("historyModal").style.display='none'; }
  
  function loadData() { 
      document.getElementById('loadingOverlay').style.display = 'flex';
      const email = currentUserContext ? currentUserContext.email : null;
      google.script.run
          .withSuccessHandler(initializeDashboard) 
          .withFailureHandler(showError)
          .getDashboardData(email); 
  }

  function updateData() { 
      document.getElementById('loadingOverlay').style.display = 'flex'; document.getElementById('loadingText').textContent = 'Mise à jour...';
      const btn = document.getElementById('btnUpdate'); if(btn) btn.classList.add('spin-anim'); 
      google.script.run.withSuccessHandler(s => { 
          if(btn) btn.classList.remove('spin-anim'); if(s.includes('succès')) loadData(); else { alert(s); document.getElementById('loadingOverlay').style.display='none'; }
      }).withFailureHandler(e => { if(btn) btn.classList.remove('spin-anim'); showError(e); }).clientNormalizeData(); 
  }

  function initializeDashboard(data) { 
      const overlay = document.getElementById('loadingOverlay');
      if(overlay) overlay.style.display = 'none'; 
      
      window.rawData = data; 
      if(data.userContext) {
          currentUserContext = data.userContext;
          
          const userName = currentUserContext.username || currentUserContext.email.split('@')[0];
          const nameEl = document.getElementById('connectedUserName');
          const posteEl = document.getElementById('connectedUserPoste');
          const photoEl = document.getElementById('connectedUserPhoto');
          
          if (nameEl) nameEl.textContent = userName.toUpperCase();
          if (posteEl) posteEl.textContent = currentUserContext.poste || 'Utilisateur';
          if (photoEl) {
              const photoUrl = currentUserContext.photo ? currentUserContext.photo : "https://ui-avatars.com/api/?name=" + userName + "&background=f8faff&color=363795&bold=true";
              photoEl.src = photoUrl;
          }
      }

      const allParts = document.querySelectorAll('.dashboard-part');
      allParts.forEach(div => div.style.display = 'none');

      if (data && data.normalizedData) { 
          window.normalizedData = data.normalizedData.slice(1).filter(r => Array.isArray(r) && r.length>0 && r[0]); 
          window.extraContactData = data.contactData || {}; 
          window.extraCAData = data.caData || {}; 
          window.extraCapacityData = data.capacity || {}; 
      } else if (Array.isArray(data)) {
          window.normalizedData = data.slice(1).filter(r => Array.isArray(r) && r.length>0 && r[0]); 
      }
      
      if(typeof populateFilters === "function") populateFilters(); 
      if(typeof applyUserPermissions === 'function') applyUserPermissions();
      
      const updateStatusEl = document.getElementById('updateStatus');
      if(updateStatusEl) updateStatusEl.textContent = 'Prêt';

      if (currentUserContext && currentUserContext.role === 'VIEWER_RECOUV') {
          switchTab('recouvrement');
          setTimeout(() => {
              if (typeof switchFamily === 'function') {
                  const btnTarget = Array.from(document.querySelectorAll('.nav-sub-btn')).find(b => 
                      b.textContent.includes("Dossiers non réglés") || 
                      (b.getAttribute('onclick') && b.getAttribute('onclick').includes("Dossiers non réglés"))
                  );
                  switchFamily('Recouvrement', 'Dossiers non réglés', btnTarget);
              } else {
                  const btnNonRegles = Array.from(document.querySelectorAll('button')).find(b => 
                      b.textContent.includes("Dossiers non réglés")
                  );
                  if (btnNonRegles) btnNonRegles.click();
              }
          }, 300);
      } else {
          if(typeof drawCharts === "function") drawCharts();
          switchTab('flash');
      }

      setTimeout(() => {
          if(typeof updateRecouvDashboard === 'function') { try { updateRecouvDashboard(); } catch(e){} }
      }, 1500);
  }

  function showError(e) { document.getElementById('loadingOverlay').style.display = 'none'; alert("Erreur : " + e.message); }
  
  function updateMonthOptions() {
      const trim = document.getElementById('trimestre').value;
      const ms = document.getElementById('mois'); const cur = ms.value; ms.innerHTML = '<option value="">TOUT</option>';
      let list = window.monthOrder; if (trim && window.quarters[trim]) list = window.quarters[trim];
      list.forEach(m => ms.add(new Option(m, m)));
      ms.value = list.includes(cur) ? cur : '';
      const lm = document.getElementById('localMois'); if(lm) { lm.innerHTML = ms.innerHTML; lm.value = ms.value; }
  }

  function syncFilters(src) {
      const he = document.getElementById('entite');
      const ht = document.getElementById('trimestre');
      const hm = document.getElementById('mois');
      const ha = document.getElementById('annee');

      const le = document.getElementById('localEntite');
      const lt = document.getElementById('localTrimestre');
      const lm = document.getElementById('localMois');
      const la = document.getElementById('localAnnee');

      const lbe = document.getElementById('localBudgetEntite');
      const lba = document.getElementById('localBudgetAnnee');
      const lbt = document.getElementById('localBudgetTrimestre');
      const lbm = document.getElementById('localBudgetMois');

      const re = document.getElementById('recouvFilterEntite');
      const ra = document.getElementById('recouvFilterAnnee');
      const rt = document.getElementById('recouvFilterTrim');
      const rm = document.getElementById('recouvFilterMois');

      const de = document.getElementById('depenseFilterEntite');
      const da = document.getElementById('depenseFilterAnnee'); 
      const dt = document.getElementById('depenseFilterTrim');
      const dm = document.getElementById('depenseFilterMois');

      const hoe = document.getElementById('honoFilterEntite');
      const hoa = document.getElementById('honoFilterAnnee');
      const hot = document.getElementById('honoFilterTrim');
      const hom = document.getElementById('honoFilterMois');
      
      const rhe = document.getElementById('rhEntite');
      const rha = document.getElementById('rhAnnee');
      const rht = document.getElementById('rhTrimestre');
      const rhm = document.getElementById('rhMois');
      
      if(src === 'entite' || src === 'trimestre' || src === 'mois' || src === 'annee') { 
          if(le && he) le.value = he.value; 
          if(la && ha) la.value = ha.value; 
          if(lt && ht) { lt.value = ht.value; updateMonthOptions(); } 
          if(lm && hm) lm.value = hm.value; 

          if(lbe && he) lbe.value = he.value;
          if(lba && ha) lba.value = ha.value;
          if(lbt && ht) lbt.value = ht.value;
          if(lbm && hm) lbm.value = hm.value;

          if(re && he) { re.value = he.value; if(re.onchange) re.onchange(); } 
          if(ra && ha) { ra.value = ha.value; }
          if(rt && ht) { rt.value = ht.value; if(rt.onchange) rt.onchange(); } 
          if(rm && hm) { rm.value = hm.value; }

          if(de && he) { de.value = he.value; if(de.onchange) de.onchange(); }
          if(dt && ht) { dt.value = ht.value; if(dt.onchange) dt.onchange(); }
          if(dm && hm) { dm.value = hm.value; }
          if(src === 'annee' && ha && da) { da.value = ha.value; if(da.onchange) da.onchange(); }

          if(hoe && he) { hoe.value = he.value; if(hoe.onchange) hoe.onchange(); }
          if(hoa && ha) { hoa.value = ha.value; }
          if(hot && ht) { hot.value = ht.value; if(hot.onchange) hot.onchange(); }
          if(hom && hm) { hom.value = hm.value; }
          
          if(rhe && he) { rhe.value = he.value; if(rhe.onchange) rhe.onchange(); }
          if(rha && ha) { rha.value = ha.value; if(rha.onchange) rha.onchange(); }
          if(rht && ht) { rht.value = ht.value; if(rht.onchange) rht.onchange(); }
          if(rhm && hm) { rhm.value = hm.value; if(rhm.onchange) rhm.onchange(); }
      }
      
      if(src && src.startsWith('local')) { 
          if(src==='localEntite' && he && le) he.value = le.value; 
          if(src==='localAnnee' && ha && la) ha.value = la.value;
          if(src==='localTrimestre' && ht && lt) { ht.value = lt.value; updateMonthOptions(); } 
          if(src==='localMois' && hm && lm) hm.value = lm.value; 
      }
      
      const at = document.querySelector('.view-section.active');
      if(at) {
          if(at.id === 'view-ca-budget' && typeof updateCaBudgetView === "function") updateCaBudgetView();
          else if (at.id === 'view-depenses' && typeof updateExpensesView === "function") updateExpensesView();
          else if (at.id === 'view-recouvrement' && typeof updateRecouvDashboard === "function") updateRecouvDashboard();
          else if (at.id === 'view-honoraires' && typeof updateHonorairesView === "function") updateHonorairesView();
          else if (at.id === 'view-flash' && typeof drawCharts === "function") drawCharts(); 
          else if (at.id === 'view-rh' && typeof drawCharts === "function") drawCharts();
      }
  }

  function applyGlobalFiltersToView(viewId) {
      const gEntite = document.getElementById('entite').value;
      const gTrim = document.getElementById('trimestre').value;
      const gMois = document.getElementById('mois').value;
      const gAnnee = document.getElementById('annee').value;

      const setVal = (id, val) => { 
          const el = document.getElementById(id); 
          if(el) { el.value = val; el.dispatchEvent(new Event('change')); } 
      };
      
      try {
          if (viewId === 'view-flash') { setVal('localEntite', gEntite); setVal('localAnnee', gAnnee); setVal('localTrimestre', gTrim); setVal('localMois', gMois); } 
          else if (viewId === 'view-ca-budget') { setVal('localBudgetEntite', gEntite); setVal('localBudgetTrimestre', gTrim); setVal('localBudgetMois', gMois); } 
          else if (viewId === 'view-recouvrement') { setVal('recouvFilterEntite', gEntite); setVal('recouvFilterTrim', gTrim); setVal('recouvFilterMois', gMois); setVal('recouvFilterAnnee', gAnnee); } 
          else if (viewId === 'view-depenses') { setVal('depenseFilterEntite', gEntite); setVal('depenseFilterTrim', gTrim); setVal('depenseFilterMois', gMois); } 
          else if (viewId === 'view-honoraires') { setVal('honoFilterEntite', gEntite); setVal('honoFilterTrim', gTrim); setVal('honoFilterMois', gMois); setVal('honoFilterAnnee', gAnnee); }
          else if (viewId === 'view-rh') { setVal('rhEntite', gEntite); setVal('rhTrimestre', gTrim); setVal('rhMois', gMois); setVal('rhAnnee', gAnnee); }
      } catch(e) { console.error(e); }
  }

  function toggleGroupList(header) {
      const body = header.nextElementSibling;
      const icon = header.querySelector('.toggle-icon');
      if (body.style.display === 'block') { body.style.display = 'none'; icon.classList.remove('rotated'); } 
      else { body.style.display = 'block'; icon.classList.add('rotated'); }
  }
  function moveUp(btn) { 
      const itemRow = btn.closest('.export-item');
      if (itemRow) { if (itemRow.previousElementSibling) itemRow.parentNode.insertBefore(itemRow, itemRow.previousElementSibling); }
      else { const group = btn.closest('.export-group'); if (group && group.previousElementSibling) group.parentNode.insertBefore(group, group.previousElementSibling); }
  }
  function moveDown(btn) { 
      const itemRow = btn.closest('.export-item');
      if (itemRow) { if (itemRow.nextElementSibling) itemRow.parentNode.insertBefore(itemRow.nextElementSibling, itemRow); }
      else { const group = btn.closest('.export-group'); if (group && group.nextElementSibling) group.parentNode.insertBefore(group.nextElementSibling, group); }
  }

  function openGlobalExportModal() {
      document.getElementById('exportModal').style.display = 'flex';
  }
  function toggleGroup(master) {
      const groupContainer = master.closest('.export-group');
      const inputs = groupContainer.querySelectorAll(`.item-check`);
      inputs.forEach(inp => inp.checked = master.checked);
  }
  async function processDynamicExport(format) {
      document.getElementById('exportModal').style.display = 'none';
      alert("Exportation démarrée. Veuillez patienter...");
  }

  function selectFamily(family) { 
      document.querySelectorAll('#familyButtons button').forEach(btn => { 
          btn.classList.toggle('active', btn.getAttribute('data-family') === family); 
      }); 
      const labelElement = document.querySelector('label[for="element"]');
      if(labelElement) { labelElement.textContent = (family === 'Hospitalisation') ? 'Service' : 'Élément'; }
      
      populateSousFamille(family); 
      populateEntiteFilter(family); 
      
      const lEntite = document.getElementById('localEntite'); 
      const entiteSelect = document.getElementById('entite');
      if(lEntite && entiteSelect) { lEntite.innerHTML = entiteSelect.innerHTML; lEntite.value = entiteSelect.value; }

      const lAnnee = document.getElementById('localAnnee');
      const anneeSelect = document.getElementById('annee');
      if(lAnnee && anneeSelect) { lAnnee.innerHTML = anneeSelect.innerHTML; lAnnee.value = anneeSelect.value; }
      
      const lMois = document.getElementById('localMois'); const moisSelect = document.getElementById('mois');
      if(moisSelect.options.length <= 1) { 
          moisSelect.innerHTML = '<option value="">TOUT</option>'; 
          monthOrder.forEach(m => moisSelect.add(new Option(m, m)));
      }
      if(lMois) { lMois.innerHTML = moisSelect.innerHTML; lMois.value = moisSelect.value; }
      
      const lTrim = document.getElementById('localTrimestre'); const trimSelect = document.getElementById('trimestre');
      if(trimSelect.options.length <= 1) { 
          trimSelect.innerHTML = '<option value="">TOUT</option><option value="T1">T1</option><option value="T2">T2</option><option value="T3">T3</option><option value="T4">T4</option>'; 
      }
      if(lTrim) { lTrim.innerHTML = trimSelect.innerHTML; lTrim.value = trimSelect.value; }
  }

  function populateEntiteFilter(selectedFamille) { 
      const entiteSelect = document.getElementById('entite'); 
      if(!entiteSelect) return;

      const currentSelection = entiteSelect.value; 
      
      const familyFilteredData = normalizedData.filter(r => r[2].toString() === selectedFamille); 
      const newEntiteSet = new Set(familyFilteredData.map(r => r[0].toString()).filter(v => v.trim() !== '')); 
      
      if(newEntiteSet.has("HIA") && newEntiteSet.has("CIOA")) newEntiteSet.add("HIA CIOA");

      entiteSelect.innerHTML = '<option value="">TOUT</option>'; 
      Array.from(newEntiteSet).sort().forEach(item => entiteSelect.add(new Option(item, item))); 
      
      entiteSelect.value = (currentSelection && newEntiteSet.has(currentSelection)) ? currentSelection : ''; 

      if (typeof applyUserPermissions === 'function') {
          applyUserPermissions(); 
      }
  }

  function populateSousFamille(selectedFamille) { 
      const sousFamilleSelect = document.getElementById('sousFamille'); 
      const currentSelection = sousFamilleSelect.value; 
      const targetData = normalizedData.filter(r => r[2].toString() === selectedFamille); 
      const sousFamilleSet = new Set(targetData.map(r => r[3].toString()).filter(isFilterValueValid)); 
      sousFamilleSelect.innerHTML = '<option value="">TOUT</option>'; 
      Array.from(sousFamilleSet).sort().forEach(item => sousFamilleSelect.add(new Option(item, item))); 
      sousFamilleSelect.value = (currentSelection && sousFamilleSet.has(currentSelection)) ? currentSelection : ''; 
      populateElementFilter(selectedFamille, sousFamilleSelect.value); 
  }

  function populateElementFilter(selectedFamille, selectedSousFamille) { 
      const elementSelect = document.getElementById('element'); 
      const currentSelection = elementSelect.value; 
      const filteredData = normalizedData.filter(r => r[2].toString() === selectedFamille && (!selectedSousFamille || r[3].toString() === selectedSousFamille)); 
      const elementSet = new Set(filteredData.map(r => r[4].toString()).filter(isFilterValueValid)); 
      elementSelect.innerHTML = '<option value="">TOUT</option>'; 
      Array.from(elementSet).sort().forEach(item => elementSelect.add(new Option(item, item))); 
      elementSelect.value = (currentSelection && elementSet.has(currentSelection)) ? currentSelection : ''; 
      if(typeof drawCharts === "function") drawCharts(); 
  }
</script>