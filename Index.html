<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASHBOARD - REGION GRAND SUD</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <?!= include('css_styles'); ?>
    
    <style>
      /* Styles sp√©cifiques au gestionnaire d'export (non inclus dans css_styles pour √©viter les conflits) */
      .export-group { border: 1px solid #e1e8f0; border-radius: 8px; margin-bottom: 12px; overflow: hidden; background: white; transition: box-shadow 0.2s; }
      .export-group:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
      .export-group-header { background: #f8faff; padding: 12px 15px; display: flex; align-items: center; border-bottom: 1px solid #eee; user-select: none; }
      .export-group-title { flex: 1; font-weight: 700; color: #2c3e50; font-size: 0.95em; display: flex; align-items: center; gap: 10px; }
      .export-group-controls { display: flex; gap: 5px; }
      .sort-btn { background: white; border: 1px solid #ccc; color: #555; width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.7em; transition: all 0.2s; }
      .sort-btn:hover { background: #363795; color: white; border-color: #363795; }
      .export-group-body { padding: 5px 0; background: white; display: none; }
      .export-group-body.open { display: block; }
      .export-item { display: flex; align-items: center; padding: 8px 15px 8px 45px; border-bottom: 1px dashed #f0f0f0; font-size: 0.9em; color: #555; transition: background 0.1s; }
      .export-item:hover { background: #fbfbfb; }
      .export-item:last-child { border-bottom: none; }
      .export-checkbox { transform: scale(1.1); margin-right: 10px; cursor: pointer; accent-color: #363795; }
      .toggle-icon { transition: transform 0.2s; color: #888; margin-right: 10px; cursor: pointer; }
      .toggle-icon.rotated { transform: rotate(90deg); }
    </style>
  </head>
  <body>
    <div id="loginOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f8fafc; z-index:99999; display:flex; justify-content:center; align-items:center;">
    <div style="background:white; padding:40px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.1); width:100%; max-width:400px; text-align:center;">
        <h2 style="margin-bottom:20px; color:#1e293b; font-family:sans-serif;">Connexion Dashboard</h2>
        
        <div style="margin-bottom:15px; text-align:left;">
            <label style="display:block; font-size:12px; font-weight:bold; color:#64748b; margin-bottom:5px;">Utilisateur</label>
            <input type="text" id="loginUser" class="form-control" placeholder="Ex: hia" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px;">
        </div>
        
        <div style="margin-bottom:25px; text-align:left;">
            <label style="display:block; font-size:12px; font-weight:bold; color:#64748b; margin-bottom:5px;">Mot de passe</label>
            <input type="password" id="loginPass" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px;">
        </div>

        <button onclick="attemptLogin()" id="btnLogin" style="width:100%; background:#363795; color:white; border:none; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer; transition:background 0.2s;">
            SE CONNECTER
        </button>
        
        <p id="loginError" style="color:#ef4444; font-size:12px; margin-top:15px; display:none;"></p>
    </div>
</div>
    
    <div id="loadingOverlay">
        <div class="loader"></div>
        <h3 id="loadingText" style="margin-top: 15px;">Chargement...</h3>
        <p id="loadingSubText" style="color: #ccc; font-size: 0.9em;">Traitement en cours</p>
    </div>

    <div id="exportModal" style="display:none; position:fixed; z-index:3000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(3px); align-items:center; justify-content:center;">
        <div style="background:white; width:650px; padding:0; border-radius:12px; box-shadow:0 15px 40px rgba(0,0,0,0.4); display:flex; flex-direction:column; max-height:90vh; overflow:hidden;">
            <div style="padding:20px; background:linear-gradient(135deg, #2c3e50 0%, #363795 100%); color:white; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 style="margin:0; font-size:1.3em; font-weight:700;"><i class="fas fa-print"></i> √âditeur de Rapport</h3>
                    <div style="font-size:0.85em; opacity:0.8; margin-top:5px;">Organisez et s√©lectionnez le contenu de votre export</div>
                </div>
                <span onclick="document.getElementById('exportModal').style.display='none'" style="cursor:pointer; font-size:1.5em; opacity:0.8; transition:0.2s;">&times;</span>
            </div>

            <div style="padding:10px 20px; background:#fff3cd; color:#856404; font-size:0.85em; border-bottom:1px solid #ffeeba; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-info-circle"></i> Utilisez les fl√®ches ‚¨ÜÔ∏è‚¨áÔ∏è pour changer l'ordre des parties dans le PDF.
            </div>

            <div id="exportCheckboxesArea" style="flex:1; overflow-y:auto; padding:20px; background:#f4f6f9;">
                </div>

            <div style="padding:20px; border-top:1px solid #eee; background:white; display:flex; justify-content:space-between; align-items:center;">
                <div style="font-size:0.9em; color:#333; font-weight:500;">
                    <label style="cursor:pointer; display:flex; align-items:center; gap:8px; margin-bottom:5px;">
                        <input type="checkbox" id="chkCover" checked class="export-checkbox"> Page de Garde & Sommaire
                    </label>
                    <label style="cursor:pointer; display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" id="chkSeparators" checked class="export-checkbox"> Pages de S√©paration
                    </label>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="processDynamicExport('pdf')" style="background:#e74c3c; color:white; border:none; padding:12px 30px; border-radius:30px; cursor:pointer; font-weight:700; display:flex; align-items:center; gap:8px; box-shadow:0 4px 10px rgba(231, 76, 60, 0.3); transition:transform 0.2s;">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button onclick="processDynamicExport('ppt')" style="background:#e67e22; color:white; border:none; padding:12px 30px; border-radius:30px; cursor:pointer; font-weight:700; display:flex; align-items:center; gap:8px; box-shadow:0 4px 10px rgba(230, 126, 34, 0.3); transition:transform 0.2s;">
                        <i class="fas fa-file-powerpoint"></i> PPT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="loginPage">
        <div class="login-card">
            <div class="login-logo">
                <div class="logo-circle">
                    <i class="fas fa-hospital-user"></i>
                </div>
                <div class="logo-text">
                    <h1>Dashboard : Rapport d'activit√©</h1>
                    <p>R√©gion Grand-Sud</p>
                </div>
            </div>

            <h2 class="login-title">Connectez-vous √† votre compte</h2>
            
            <div class="login-body">
                <div class="google-btn" onclick="attemptLogin()">
                    <img src="https://user-images.githubusercontent.com/194400/70987158-4069c900-20b7-11ea-892e-8a2e1166b6b7.png" alt="G">
                    <span>Se connecter avec Google</span>
                </div>

                <div id="loginError" style="color: red; text-align: center; margin-top: 20px; font-size: 0.9em; display: none;"></div>
            </div>
        </div>
    </div>

    <div id="historyModal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('historyModal').style.display='none'">&times;</span>
            <h3 id="modalTitle">√âvolution</h3>
            <div id="modalSubtitle"></div>
            <div style="height: 350px;">
                <canvas id="historyChart"></canvas>
            </div>
        </div>
    </div>

    <div id="appContainer" style="display:none; flex-direction:column; height:100vh;">
        
        <header>
          <div class="header-left">
            <button id="sidebarToggle" onclick="toggleSidebar()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">&#9776;</button>
            <h2>Rapport d'activit√©</h2>
          </div>
          <div class="header-center">
              <div class="nav-tabs">
                  <button class="nav-tab-btn active" onclick="switchTab('flash')">Flash</button>
                  <button class="nav-tab-btn" onclick="switchTab('ca-budget')">CA vs Budget</button>
                  <button class="nav-tab-btn" onclick="switchTab('recouvrement')">Recouvrement & Exp√©dition</button>
                  <button class="nav-tab-btn" onclick="switchTab('depenses')">D√©penses</button>
                  <button class="nav-tab-btn" onclick="switchTab('honoraires')">Honoraires</button>
                  <button class="nav-tab-btn" onclick="switchTab('rh')">RH</button>                  
              </div>
              
              <div class="header-filters" id="globalFilters">
                  <label>Entit√©</label>
                  <select id="entite" class="header-select" onchange="syncFilters('entite')"></select>
                  <label>Ann√©e</label>
                  <select id="annee" class="header-select" onchange="syncFilters('annee')"></select>
                  <label>Trim</label>
                  <select id="trimestre" class="header-select" onchange="updateMonthOptions(); syncFilters('trimestre')"></select>
                  <label>Mois</label>
                  <select id="mois" class="header-select" onchange="syncFilters('mois')"></select>
              </div>
          </div>
          <div class="header-right">
              <button class="action-btn" onclick="toggleDarkMode()" title="Mode Sombre">üåô</button>
              <button id="btnUpdate" class="action-btn" onclick="updateData()" title="Actualiser les donn√©es">
                  <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
              </button>
              <button class="action-btn" onclick="openGlobalExportModal()" title="G√©n√©rer Rapport">
                  <svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
              </button>
              <span style="font-size:0.8em; margin-left:5px; opacity:0.8; white-space:nowrap;" id="updateStatus">Pr√™t</span>
          </div>
        </header>
        
        <div class="app-layout">
          <div id="sidebar">
            <div id="sidebarProfile">
                <div class="sb-profile-group">
                    <div class="sb-label">Responsable Exploitation</div>
                    <div id="sbRespExploit" class="sb-value">--</div>
                </div>
                <div class="sb-profile-group">
                    <div class="sb-label">Directeur M√©dical</div>
                    <div id="sbDirMedical" class="sb-value">--</div>
                </div>
            </div>
            <div id="familyContainer">
                <h3>Famille</h3>
                <div id="familyButtons"></div>
            </div>
          </div>

          <div class="main-content" id="mainContent">
            <?!= include('part_flash'); ?>
            <?!= include('part_budget'); ?>
            <?!= include('part_recouvrement'); ?> 
            <?!= include('part_depenses'); ?> 
            <?!= include('part_honoraires'); ?>
            <?!= include('part_rh'); ?> 
          </div>
        </div> 
    
    </div> <?!= include('js_global'); ?>
    <?!= include('js_flash'); ?>
    <?!= include('js_budget'); ?>
    <?!= include('js_recouvrement_core'); ?>
    <?!= include('js_recouvrement_non_regles'); ?>
    <?!= include('js_recouvrement_expedition'); ?>
    <?!= include('js_recouvrement_retours'); ?>
    <?!= include('js_recouvrement_objectifs'); ?> 
    <?!= include('js_depenses'); ?>
    <?!= include('js_honoraires'); ?>
    <?!= include('js_rh'); ?>
  </body>
</html>
<script>
// --- GESTION LOGIN ---

// Emp√™che le d√©filement tant que pas connect√©
document.body.style.overflow = 'hidden';

function attemptLogin() {
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value.trim();
    const btn = document.getElementById('btnLogin');
    const err = document.getElementById('loginError');

    if(!u || !p) {
        err.textContent = "Veuillez remplir tous les champs.";
        err.style.display = 'block';
        return;
    }

    // UI Loading
    btn.disabled = true;
    btn.textContent = "V√©rification...";
    err.style.display = 'none';

    google.script.run
        .withSuccessHandler(function(res) {
            if (res.success) {
                // 1. Stocker le contexte utilisateur
                window.currentUserContext = {
                    role: res.role,
                    entity: res.entity,
                    email: res.username // On utilise le username comme email pour l'affichage
                };

                // 2. Appliquer les droits visuels (Masquer menus ADMIN si n√©cessaire)
                applyUserPermissions(res.role, res.entity);

                // 3. Masquer l'√©cran de connexion
                document.getElementById('loginOverlay').style.display = 'none';
                document.body.style.overflow = 'auto';

                // 4. Lancer le chargement des donn√©es (Si ce n'est pas d√©j√† fait au onload)
                // if(typeof initDashboard === 'function') initDashboard(); 

            } else {
                err.textContent = res.message;
                err.style.display = 'block';
                btn.disabled = false;
                btn.textContent = "SE CONNECTER";
            }
        })
        .withFailureHandler(function(e) {
            err.textContent = "Erreur de connexion serveur.";
            err.style.display = 'block';
            btn.disabled = false;
            btn.textContent = "SE CONNECTER";
        })
        .verifyCustomLogin(u, p);
}

// Fonction pour restreindre l'interface selon le r√¥le
function applyUserPermissions(role, entity) {
    console.log("Connexion r√©ussie : " + role + " - " + entity);
    
    // Exemple : Pr√©-remplir le filtre Entit√© et le verrouiller si VIEWER_ENTITY
    const entiteFilter = document.getElementById('recouvFilterEntite');
    if (entiteFilter && role === 'VIEWER_ENTITY') {
        entiteFilter.value = entity;
        entiteFilter.disabled = true; // Emp√™che de changer d'entit√©
        
        // Simuler le changement pour rafraichir les graphiques
        if(typeof updateRecouvDashboard === 'function') updateRecouvDashboard();
    }
    
    // Masquer le bouton import si pas ADMIN
    const btnImport = document.querySelector('button[onclick="triggerObjRealImport()"]');
    if (btnImport && role !== 'ADMIN') {
        btnImport.style.display = 'none';
    }
}

// Permettre la validation avec la touche Entr√©e
document.getElementById('loginPass').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') attemptLogin();
});
</script>