<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASHBOARD - REGION GRAND SUD</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <?!= include('css_styles'); ?>
    
    <style>
      /* Styles sp√©cifiques (Export, Login, Modales) */
      .export-group { border: 1px solid #e1e8f0; border-radius: 8px; margin-bottom: 12px; overflow: hidden; background: white; transition: box-shadow 0.2s; }
      .export-group:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
      .export-group-header { background: #f8faff; padding: 12px 15px; display: flex; align-items: center; border-bottom: 1px solid #eee; user-select: none; }
      .export-group-title { flex: 1; font-weight: 700; color: #2c3e50; font-size: 0.95em; display: flex; align-items: center; gap: 10px; }
      .export-group-controls { display: flex; gap: 5px; }
      .sort-btn { background: white; border: 1px solid #ccc; color: #555; width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.7em; transition: all 0.2s; }
      .sort-btn:hover { background: #363795; color: white; border-color: #363795; }
      .export-group-body { padding: 5px 0; background: white; display: none; }
      .export-group-body.open { display: block; }
      .export-item { display: flex; align-items: center; padding: 8px 15px 8px 45px; border-bottom: 1px dashed #f0f0f0; font-size: 0.9em; color: #555; transition: background 0.1s; }
      .export-item:hover { background: #fbfbfb; }
      .export-item:last-child { border-bottom: none; }
      .export-checkbox { transform: scale(1.1); margin-right: 10px; cursor: pointer; accent-color: #363795; }
      
      /* Login Overlay Styles */
      #loginOverlay { font-family: 'Segoe UI', sans-serif; }
      .login-input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; outline: none; transition: border-color 0.3s; }
      .login-input:focus { border-color: #3b82f6; }
      .login-label { display: block; font-size: 12px; font-weight: 700; color: #475569; margin-bottom: 5px; text-align: left; }
    </style>
  </head>
  <body>

<div id="loginOverlay" class="login-wrapper">
        <div class="login-main-card">
            
            <div class="login-left-panel">
                <div class="login-left-overlay"></div>
                <div class="login-left-content">
                    <h3 style="color: white; font-weight: 300; font-size: 1.4rem; margin-bottom: 30px;">Dashboard <br><strong style="font-weight: 800;">R√©gion Grand-Sud</strong></h3>
                    
                    <div class="founders-box">
                        <p style="color: rgba(255,255,255,0.7); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;">Cr√©√© & D√©velopp√© par</p>
                        
                        <div class="founder-profile">
                            <img src="https://myakdital.humaneo.ma/rails/active_storage/blobs/redirect/eyJfcmFpbHMiOnsiZGF0YSI6MjMxODgsInB1ciI6ImJsb2JfaWQifX0=--fd8a05afa2f8049866ac0b5e8524fc94c5b68e09/yahyaoui_sami.jpg" alt="S. Yahyaoui">
                            <div class="founder-info">
                                <h4>Sami Yahyaoui</h4>
                                <span>Charg√© de Reporting R√©gional</span>
                            </div>
                        </div>
                        
                        <div class="founder-profile">
                            <img src="https://ui-avatars.com/api/?name=Fondateur+2&background=fff&color=005c97" alt="O. Duieb">
                            <div class="founder-info">
                                <h4>Othmane Duieb</h4>
                                <span>Charg√© de reporting</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="login-right-panel">
                <div class="login-form-container">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/5/56/Akdital_%281%29.png" alt="AKDITAL" class="akdital-logo">
                    
                    <h2 class="login-title">Bienvenue</h2>
                    <p class="login-subtitle">Veuillez vous authentifier pour acc√©der √† votre espace.</p>
                    
                    <div class="google-active-account">
                        <i class="fab fa-google"></i>
                        <div class="google-account-info">
                            <span>Compte Google connect√©</span>
                            <strong><?= userEmail ?></strong>
                            <input type="hidden" id="detectedEmail" value="<?= userEmail ?>">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="login-label">Identifiant</label>
                        <div class="input-icon-wrapper">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" id="loginUser" class="login-input" placeholder="Ex: s.yahyaoui">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="login-label">Mot de passe</label>
                        <div class="input-icon-wrapper">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="loginPass" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
            
                    <button onclick="attemptLogin()" id="btnLogin" class="btn-primary">
                        SE CONNECTER <i class="fas fa-arrow-right"></i>
                    </button>
                    
                    <p id="loginError" class="login-error-msg"></p>
        
                    <div class="forgot-password">
                        <a href="#" onclick="document.getElementById('forgotOverlay').style.display='flex'; return false;">Mot de passe oubli√© ?</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="forgotOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999999; justify-content:center; align-items:center; backdrop-filter:blur(2px);">
        <div style="background:white; padding:30px; border-radius:10px; width:350px; text-align:center; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0; color:#333;">R√©cup√©ration</h3>
            <p style="font-size:12px; color:#666; margin-bottom:15px;">Un nouveau mot de passe sera envoy√© √† votre adresse email professionnelle.</p>
            <input type="email" id="resetEmail" class="login-input" placeholder="Votre email..." style="margin-bottom:15px;">
            <div style="display:flex; gap:10px;">
                <button onclick="document.getElementById('forgotOverlay').style.display='none'" style="flex:1; background:#f1f5f9; border:1px solid #cbd5e1; color:#333; padding:10px; border-radius:5px; cursor:pointer;">Annuler</button>
                <button onclick="doResetPass()" style="flex:1; background:#363795; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer; font-weight:bold;">Envoyer</button>
            </div>
        </div>
    </div>

    <div id="changePassModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center; backdrop-filter:blur(2px);">
        <div style="background:white; padding:30px; border-radius:10px; width:350px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0; color:#333; text-align:center;">Changer Mot de passe</h3>
            
            <label class="login-label">Ancien mot de passe</label>
            <input type="password" id="cpOld" class="login-input" style="margin-bottom:15px;">
            
            <label class="login-label">Nouveau mot de passe</label>
            <input type="password" id="cpNew" class="login-input" style="margin-bottom:20px;">
            
            <div style="display:flex; gap:10px;">
                <button onclick="document.getElementById('changePassModal').style.display='none'" style="flex:1; background:#f1f5f9; border:1px solid #cbd5e1; color:#333; padding:10px; border-radius:5px; cursor:pointer;">Annuler</button>
                <button onclick="doChangePass()" style="flex:1; background:#10b981; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer; font-weight:bold;">Valider</button>
            </div>
            <p id="cpError" style="color:#ef4444; font-size:11px; margin-top:10px; display:none; text-align:center;"></p>
        </div>
    </div>
    
    <div id="loadingOverlay">
        <div class="loader"></div>
        <h3 id="loadingText" style="margin-top: 15px;">Chargement...</h3>
        <p id="loadingSubText" style="color: #ccc; font-size: 0.9em;">Connexion s√©curis√©e en cours</p>
    </div>

    <div id="exportModal" style="display:none; position:fixed; z-index:3000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(3px); align-items:center; justify-content:center;">
        <div style="background:white; width:650px; padding:0; border-radius:12px; box-shadow:0 15px 40px rgba(0,0,0,0.4); display:flex; flex-direction:column; max-height:90vh; overflow:hidden;">
            <div style="padding:20px; background:linear-gradient(135deg, #2c3e50 0%, #363795 100%); color:white; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 style="margin:0; font-size:1.3em; font-weight:700;"><i class="fas fa-print"></i> √âditeur de Rapport</h3>
                    <div style="font-size:0.85em; opacity:0.8; margin-top:5px;">Organisez et s√©lectionnez le contenu de votre export</div>
                </div>
                <span onclick="document.getElementById('exportModal').style.display='none'" style="cursor:pointer; font-size:1.5em; opacity:0.8; transition:0.2s;">&times;</span>
            </div>

            <div style="padding:10px 20px; background:#fff3cd; color:#856404; font-size:0.85em; border-bottom:1px solid #ffeeba; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-info-circle"></i> Utilisez les fl√®ches ‚¨ÜÔ∏è‚¨áÔ∏è pour changer l'ordre des parties dans le PDF.
            </div>

            <div id="exportCheckboxesArea" style="flex:1; overflow-y:auto; padding:20px; background:#f4f6f9;">
                </div>

            <div style="padding:20px; border-top:1px solid #eee; background:white; display:flex; justify-content:space-between; align-items:center;">
                <div style="font-size:0.9em; color:#333; font-weight:500;">
                    <label style="cursor:pointer; display:flex; align-items:center; gap:8px; margin-bottom:5px;">
                        <input type="checkbox" id="chkCover" checked class="export-checkbox"> Page de Garde & Sommaire
                    </label>
                    <label style="cursor:pointer; display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" id="chkSeparators" checked class="export-checkbox"> Pages de S√©paration
                    </label>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="processDynamicExport('pdf')" style="background:#e74c3c; color:white; border:none; padding:12px 30px; border-radius:30px; cursor:pointer; font-weight:700; display:flex; align-items:center; gap:8px; box-shadow:0 4px 10px rgba(231, 76, 60, 0.3); transition:transform 0.2s;">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button onclick="processDynamicExport('ppt')" style="background:#e67e22; color:white; border:none; padding:12px 30px; border-radius:30px; cursor:pointer; font-weight:700; display:flex; align-items:center; gap:8px; box-shadow:0 4px 10px rgba(230, 126, 34, 0.3); transition:transform 0.2s;">
                        <i class="fas fa-file-powerpoint"></i> PPT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="historyModal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('historyModal').style.display='none'">&times;</span>
            <h3 id="modalTitle">√âvolution</h3>
            <div id="modalSubtitle"></div>
            <div style="height: 350px;"><canvas id="historyChart"></canvas></div>
        </div>
    </div>

    <div id="appContainer" style="display:none; flex-direction:column; height:100vh;">
        
        <header>
          <div class="header-left">
            <button id="sidebarToggle" onclick="toggleSidebar()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">&#9776;</button>
            <h2>Rapport d'activit√©</h2>
          </div>
          <div class="header-center">
              <div class="nav-tabs">
                  <button class="nav-tab-btn active" onclick="switchTab('flash')">Flash</button>
                  <button class="nav-tab-btn" onclick="switchTab('ca-budget')">CA vs Budget</button>
                  <button class="nav-tab-btn" onclick="switchTab('recouvrement')">Recouvrement & Exp√©dition</button>
                  <button class="nav-tab-btn" onclick="switchTab('depenses')">D√©penses</button>
                  <button class="nav-tab-btn" onclick="switchTab('honoraires')">Honoraires</button>
                  <button class="nav-tab-btn" onclick="switchTab('rh')">RH</button>                  
              </div>
              
              <div class="header-filters" id="globalFilters">
                  <label>Entit√©</label>
                  <select id="entite" class="header-select" onchange="syncFilters('entite')"></select>
                  <label>Ann√©e</label>
                  <select id="annee" class="header-select" onchange="syncFilters('annee')"></select>
                  <label>Trim</label>
                  <select id="trimestre" class="header-select" onchange="updateMonthOptions(); syncFilters('trimestre')"></select>
                  <label>Mois</label>
                  <select id="mois" class="header-select" onchange="syncFilters('mois')"></select>
              </div>
          </div>
<div class="header-right">
        <div class="user-profile-widget" onclick="openChangePassModal()" title="Changer de mot de passe">
            <img id="connectedUserPhoto" src="https://ui-avatars.com/api/?name=User&background=f4f6f9&color=363795" alt="Profil">
            <div class="user-profile-info">
                <span id="connectedUserName">Chargement...</span>
                <span id="connectedUserPoste">---</span>
            </div>
        </div>
        
        <div style="width: 1px; height: 30px; background: rgba(255,255,255,0.2); margin: 0 10px;"></div>
        
        <button class="action-btn" onclick="toggleDarkMode()" title="Mode Sombre">üåô</button>
        <button id="btnUpdate" class="action-btn" onclick="updateData()" title="Actualiser">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="white"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
        </button>
        <button class="action-btn" onclick="openGlobalExportModal()" title="G√©n√©rer Rapport">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="white"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
        </button>
    </div>
          
        </header>
        
        <div class="app-layout">
          <div id="sidebar">
            <div id="sidebarProfile">
                <div class="sb-profile-group">
                    <div class="sb-label">Responsable Exploitation</div>
                    <div id="sbRespExploit" class="sb-value">--</div>
                </div>
                <div class="sb-profile-group">
                    <div class="sb-label">Directeur M√©dical</div>
                    <div id="sbDirMedical" class="sb-value">--</div>
                </div>
            </div>
            <div id="familyContainer">
                <h3>Famille</h3>
                <div id="familyButtons"></div>
            </div>
          </div>

          <div class="main-content" id="mainContent">
            <?!= include('part_flash'); ?>
            <?!= include('part_budget'); ?>
            <?!= include('part_recouvrement'); ?> 
            <?!= include('part_depenses'); ?> 
            <?!= include('part_honoraires'); ?>
            <?!= include('part_rh'); ?> 
          </div>
        </div> 
    </div> 

    <?!= include('js_global'); ?>
    <?!= include('js_flash'); ?>
    <?!= include('js_budget'); ?>
    <?!= include('js_recouvrement_core'); ?>
    <?!= include('js_recouvrement_non_regles'); ?>
    <?!= include('js_recouvrement_expedition'); ?>
    <?!= include('js_recouvrement_retours'); ?>
    <?!= include('js_recouvrement_objectifs'); ?> 
    <?!= include('js_depenses'); ?>
    <?!= include('js_honoraires'); ?>
    <?!= include('js_rh'); ?>

    <script>
    // --- GESTION LOGIN SECURISE ---
    
    document.body.style.overflow = 'hidden';
    var clientIP = "Unknown";

// --- GESTION LOGIN SECURISE + IP LOGS ---
    
    document.body.style.overflow = 'hidden';
    var clientIP = "Unknown";

    // 1. INITIALISATION AU CHARGEMENT (Modifi√©)
    window.onload = function() {
        // A. R√©cup√©ration IP (Service tiers)
        fetch('https://api.ipify.org?format=json')
            .then(res => res.json())
            .then(data => { clientIP = data.ip; })
            .catch(e => console.log('IP non d√©tect√©e'));

        // B. REMPLISSAGE AUTO DU USERNAME ET VERROUILLAGE
        const detectedEmailEl = document.getElementById('detectedEmail');
        const loginUserEl = document.getElementById('loginUser');

        if (detectedEmailEl && loginUserEl) {
            const email = detectedEmailEl.value.trim().toLowerCase();
            
            // Si un email est bien d√©tect√© (ex: s.yahyaoui@akdital.ma)
            if (email && email.includes('@')) {
                // On extrait le pr√©fixe (s.yahyaoui)
                const prefix = email.split('@')[0];
                
                // On remplit le champ
                loginUserEl.value = prefix;
                
                // On le verrouille visuellement (Gris√©)
                loginUserEl.disabled = true;
                loginUserEl.style.backgroundColor = "#e5e7eb"; // Gris clair
                loginUserEl.style.color = "#6b7280";           // Texte gris fonc√©
                loginUserEl.style.cursor = "not-allowed";      // Curseur interdit
                loginUserEl.style.borderColor = "#cbd5e1";
                loginUserEl.title = "Identifiant verrouill√© selon votre email connect√©";
                
                // On met le focus directement sur le mot de passe pour gagner du temps
                setTimeout(() => document.getElementById('loginPass').focus(), 100);
            }
        }
    };
    
    // 2. TENTATIVE DE CONNEXION (L√©g√®rement adapt√©e pour lire le champ d√©sactiv√©)
    function attemptLogin() {
      const u = document.getElementById('loginUser').value.trim().toLowerCase();
      const p = document.getElementById('loginPass').value.trim();
      const detectedEmailEl = document.getElementById('detectedEmail');
      const detectedEmail = detectedEmailEl ? detectedEmailEl.value.trim().toLowerCase() : '';
      
      const btn = document.getElementById('btnLogin');
      const err = document.getElementById('loginError');

      if(!u || !p) {
          err.innerHTML = "<i class='fas fa-exclamation-circle'></i> Veuillez remplir l'utilisateur et le mot de passe.";
          err.style.display = 'block';
          return;
      }

      if (detectedEmail) {
          const prefix = detectedEmail.split('@')[0];
          if (u !== prefix) {
              err.innerHTML = `<i class='fas fa-shield-alt'></i> <b>Erreur de s√©curit√© :</b><br>L'utilisateur saisi (<b>${u}</b>) ne correspond pas au compte Google connect√© (<b>${prefix}</b>).`;
              err.style.display = 'block';
              return;
          }
      }

      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> V√©rification...';
      err.style.display = 'none';

      google.script.run
          .withSuccessHandler(function(res) {
              if (res.success) {
                  window.currentUserContext = {
                      role: res.role,
                      entity: res.entity,
                      username: res.username,
                      email: res.email,
                      poste: res.poste,
                      photo: res.photo
                  };

                  const nameEl = document.getElementById('connectedUserName');
                  const posteEl = document.getElementById('connectedUserPoste');
                  const photoEl = document.getElementById('connectedUserPhoto');
                  
                  if (nameEl) nameEl.textContent = res.username.toUpperCase();
                  if (posteEl) posteEl.textContent = res.poste || 'Utilisateur';
                  
                  if (photoEl) {
                      const photoUrl = res.photo ? res.photo : `https://ui-avatars.com/api/?name=${res.username}&background=f8faff&color=363795&bold=true`;
                      photoEl.src = photoUrl;
                  }

                  if(typeof applyUserPermissions === 'function') {
                      applyUserPermissions(res.role, res.entity);
                  }

                  const overlay = document.getElementById('loginOverlay');
                  overlay.style.transition = 'opacity 0.5s';
                  overlay.style.opacity = '0';
                  
                  setTimeout(() => { 
                      overlay.style.display = 'none'; 
                      document.body.style.overflow = 'auto';
                      
                      const app = document.getElementById('appContainer');
                      if(app) {
                          app.style.display = 'flex';
                          if(typeof loadData === 'function') loadData(); 
                          window.dispatchEvent(new Event('resize'));
                      }
                  }, 500);

              } else {
                  err.innerHTML = `<i class='fas fa-exclamation-triangle'></i> ${res.message}`;
                  err.style.display = 'block';
                  btn.disabled = false;
                  btn.innerHTML = 'SE CONNECTER <i class="fas fa-arrow-right"></i>';
              }
          })
          .withFailureHandler(function(e) {
              err.innerHTML = `<i class='fas fa-wifi'></i> Erreur de connexion serveur : ${e.message}`;
              err.style.display = 'block';
              btn.disabled = false;
              btn.innerHTML = 'SE CONNECTER <i class="fas fa-arrow-right"></i>';
          })
          .verifyCustomLogin(u, p, window.clientIP || "Unknown"); 
  }


    // 2. MOT DE PASSE OUBLI√â
    function doResetPass() {
        const email = document.getElementById('resetEmail').value;
        if(!email) return alert("Veuillez saisir votre email.");
        
        const btn = document.querySelector('#forgotOverlay button:nth-child(2)'); // Bouton Envoyer
        const txt = btn.innerText;
        btn.innerText = "Envoi...";
        btn.disabled = true;

        google.script.run
            .withSuccessHandler(function(res) {
                alert(res.message);
                document.getElementById('forgotOverlay').style.display = 'none';
                btn.innerText = txt;
                btn.disabled = false;
            })
            .resetUserPassword(email);
    }

    // 3. CHANGER MOT DE PASSE
    function openChangePassModal() {
        document.getElementById('changePassModal').style.display = 'flex';
        document.getElementById('cpOld').value = "";
        document.getElementById('cpNew').value = "";
        document.getElementById('cpError').style.display = 'none';
    }

    function doChangePass() {
        const oldP = document.getElementById('cpOld').value;
        const newP = document.getElementById('cpNew').value;
        const err = document.getElementById('cpError');
        
        if(!oldP || !newP) {
            err.textContent = "Tous les champs sont requis.";
            err.style.display = 'block';
            return;
        }

        google.script.run
            .withSuccessHandler(function(res) {
                if(res.success) {
                    alert("Mot de passe modifi√© avec succ√®s !");
                    document.getElementById('changePassModal').style.display = 'none';
                } else {
                    err.textContent = res.message;
                    err.style.display = 'block';
                }
            })
            .changeUserPassword(window.currentUserContext.username, oldP, newP, clientIP);
    }
    
    document.getElementById('loginPass').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') attemptLogin();
    });
    </script>
  </body>
</html>